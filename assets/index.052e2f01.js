import{g as e,d as t,a as i,b as n,I as r,p as a,v as o}from"./vendor.ce0ff7dc.js";const s=new e.exports.GPU({mode:"gpu"});function c(e,t,i){return e+i*t}s.addFunction(c);const l=(e,t,i)=>{const n=Math.trunc(Math.abs(e.data[0].imageWidth-t.data[0].imageWidth)/i),r=Math.trunc(Math.abs(e.data[0].imageLength-t.data[0].imageLength)/i);return s.createKernel((function(e,t){const i=this.thread.x*this.constants.useEveryXPixel,n=this.thread.y*this.constants.useEveryXPixel;let r=0;for(let a=0;a<this.constants.cropLayerWidth;a+=this.constants.useEveryXPixel){const o=i+a;for(let a=0;a<this.constants.cropLayerLength;a+=this.constants.useEveryXPixel){const s=n+a,l=c(o,s,this.constants.sourceImageLayerWidth),d=c(o-i,s-n,this.constants.cropLayerWidth),h=e[l],g=t[d];r+=Math.abs(h-g)}}return r})).setOutput([n,r]).setConstants({sourceImageLayerWidth:e.data[0].imageWidth,cropLayerWidth:t.data[0].imageWidth,cropLayerLength:t.data[0].imageLength,useEveryXPixel:i})},d=(e,t,i,n,r,a,o)=>{const{xAxisScans:l,yAxisScans:d}=g(e,t,i,n);return s.createKernel((function(e,t){const i=this.thread.x*this.constants.useEveryXPixel+this.constants.originX,n=this.thread.y*this.constants.useEveryXPixel+this.constants.originY;let r=0;for(let a=0;a<this.constants.cropLayerWidth;a+=this.constants.useEveryXPixel){const o=i+a;for(let a=0;a<this.constants.cropLayerLength;a+=this.constants.useEveryXPixel){const s=n+a,l=c(o,s,this.constants.sourceImageLayerWidth),d=c(o-i,s-n,this.constants.cropLayerWidth),h=e[l],g=t[d];r+=Math.abs(h-g)}}return r})).setOutput([l,d]).setConstants({sourceImageLayerWidth:e.data[0].imageWidth,cropLayerWidth:t.data[0].imageWidth,cropLayerLength:t.data[0].imageLength,useEveryXPixel:r,originX:a,originY:o})},h=(e,t,i)=>Math.min(Math.max(e,t),i),g=(e,t,i,n)=>{const{useEveryXPixel:r,useEveryXLayer:a}=n(),o=Math.abs(e.data[0].imageWidth-t.data[0].imageWidth),s=h(i.x-r,0,o),c=h(i.x+r,0,o)-s,l=Math.abs(e.data[0].imageLength-t.data[0].imageLength),d=h(i.y-r,0,l),g=h(i.y+r,0,l)-d,u=Math.abs(e.data.length-t.data.length),p=h(i.z-a,0,u);return{xScanStart:s,xAxisScans:c,yScanStart:d,yAxisScans:g,zScanStart:p,zAxisScans:h(i.z+a,0,u)-p}},u=({result:e,crop:t,convertPosition:i,threshold:n=.1})=>{const{useEveryXPixel:r,useEveryXLayer:a}=i(),o=(({threshold:e=.1,cropWidth:t,cropHeight:i,range:n=[0,255],useEveryXPixel:r})=>e*Math.abs(n[0]-n[1])*Math.trunc(t/r*i/r))({threshold:n,cropWidth:t.data[0].imageWidth,cropHeight:t.data[0].imageLength,useEveryXPixel:r,useEveryXLayer:a}),s=[];for(const[c,l]of Object.entries(e))for(const[e,t]of Object.entries(l))for(const[i,n]of Object.entries(t))if(n<o){const t=[c,e,i].map((e=>parseInt(e)));s.push({difference:n,index:t})}if(0==s.length)return null;return s.map((e=>{const t=e.index;return Object.assign(i({x:t[2],y:t[1],z:t[0]}),{difference:e.difference})}))},p=(e,t,{useEveryXPixel:i,useEveryXLayer:n,threshold:r})=>{const[a,o]=((e,t,{useEveryXLayer:i,useEveryXPixel:n})=>{const r=l(e,t,n),a=Math.abs(e.data.length-t.data.length);let o=[];for(let s=0;s<=a;s+=i){const i=e.data[s],n=t.data[0];o.push(r(i.data,n.data))}return r.destroy(),[o,(e=null)=>null==e?{useEveryXPixel:n,useEveryXLayer:i}:{x:e.x*n,y:e.y*n,z:e.z*i}]})(e,t,{useEveryXPixel:i,useEveryXLayer:n});return[u({result:a,crop:t,convertPosition:o,threshold:r}),o,a]},m=(e,t,i,n,{useEveryXPixel:r,useEveryXLayer:a,threshold:o})=>{const[s,c]=((e,t,i,n,{useEveryXLayer:r,useEveryXPixel:a})=>{const o=i.map(((r,o)=>{const{xScanStart:s,yScanStart:c}=g(e,t,i[o],n);return d(e,t,r,n,a,s,c)})).map(((a,o)=>{const{zScanStart:s,zAxisScans:c}=g(e,t,i[o],n);let l=[];for(let i=s;i<=s+c;i+=r){const n=e.data[i],r=t.data[0];l.push(a(n.data,r.data))}return a.destroy(),l})),{zScanStart:s,xScanStart:c,yScanStart:l}=g(e,t,i[0],n);return[o,(e=null)=>null==e?{useEveryXPixel:a,useEveryXLayer:r}:{x:e.x*a+c,y:e.y*a+l,z:e.z*r+s}]})(e,t,i,n,{useEveryXPixel:r,useEveryXLayer:a});return[s.map((e=>u({result:e,crop:t,convertPosition:c,threshold:o}))).reduce(((e,t)=>e.concat(t)),[]),c,s]},y=e=>e.reduce(((e,t)=>null==t?e:t.difference<e.difference?t:e),{difference:Number.MAX_VALUE}),v=async(e,t,{isRotated:i=!1,pipelineLayerCompleteCallback:n=null}={})=>{const r=f(t),a=[{useEveryXPixel:r,useEveryXLayer:50,threshold:.1},{useEveryXPixel:r,useEveryXLayer:5,threshold:.12},{useEveryXPixel:1,useEveryXLayer:1,threshold:.01}],o=[{useEveryXPixel:r,useEveryXLayer:50,threshold:.1},{useEveryXPixel:r,useEveryXLayer:5,threshold:.12},{useEveryXPixel:1,useEveryXLayer:1,threshold:.03}],{errors:s,pipeline:c,bestPosition:l}=await((e,t,i,n=null)=>{const r=[];let a=0;return new Promise((o=>{const s=setInterval((()=>{if(a==i.length)return clearInterval(s),null==r[r.length-1][0][0]?void o({errors:["No match found"]}):void o({pipeline:r,bestPosition:y(r[r.length-1][0])});if(a>r.length)return;const{useEveryXPixel:c,useEveryXLayer:l,threshold:d}=i[a];if(0===a){const[o,s,h]=p(e,t,{useEveryXPixel:c,useEveryXLayer:l,threshold:d});return r.push([o,s,h]),null!=n&&n({layers:i.length,layerFinished:a+1}),void a++}if(null==r[a-1][0]||0===r[a-1][0].length)return clearInterval(s),void o({errors:["No match found"]});if(!r[a-1][0].some((e=>null!=e)))return clearInterval(s),void o({errors:["No match found"]});const h=[y(r[a-1][0])],[g,u,v]=m(e,t,h,r[a-1][1],{useEveryXPixel:c,useEveryXLayer:l,threshold:d});r.push([g,u,v]),null!=n&&n({layers:i.length,layerFinished:a+1}),a++}),0)}))})(e,t,i?o:a,n);return{errors:s,pipeline:c,bestPosition:l}},f=e=>{const t=Math.min(e.data[0].imageWidth,e.data[0].imageLength);return t<=50?1:t<100?4:10},w=e=>{document.querySelector("#progress-bar > div").style.width=`${Math.round(100*e)}%`},x=e=>{null!=e&&null!=e&&e.forEach((e=>(e=>{document.querySelector("#crop-info").innerHTML=`<span>${e}</span>`,w(1)})(e)))},L=async({imagePath:e=null,arrayBuffer:r=null})=>{if(null==e&&null==r)return{errors:["No image provided"]};if(null!=e){const t=(e=>{const t=[];return null!=e&&null!=e||t.push("No image path provided"),t})(e);if(0!=t.length)return{errors:t};r=await(async e=>{const t=await i.get(e,{responseType:"arraybuffer"});return n.Buffer.from(t.data,"utf-8")})(e)}let a;try{a=t(r)}catch(o){return{errors:["An image provided is not a tiff. Currently this tool only accepts tiffs."]}}return{data:a}},E=({errorHandler:e=x,callback:t})=>async i=>{const n=i.target.files[0],r=await n.arrayBuffer(),{data:a,errors:o}=await L({arrayBuffer:r,getImageDimensions:async()=>{const e=window.URL.createObjectURL(n);return await(e=>new Promise((t=>{const i=new Image;i.onload=()=>{t({imageHeight:i.height,imageWidth:i.width})},i.src=e})))(e)}});e(o),null!=a&&t({data:a,original:a,dimensions:{width:a[0].imageWidth,height:a[0].imageLength},originalDimensions:{width:a[0].imageWidth,height:a[0].imageLength}})},b=(e,t,i,n)=>{let a=new r(t,i,e,{kind:"GREY"});return a=a.rotate(-n,{interpolation:"bilinear"}),a},S=(e,t)=>{const i=Math.max(e.parent.width,e.parent.height),n=Math.abs(i*Math.sin(X(t))),r=n/(Math.abs(i*Math.cos(X(t)))+n)*i,a=Math.trunc(r*Math.cos(X(t))),o=Math.trunc(n-r*Math.sin(X(t))),s=e.width-o-a,c=e.height-a-o;return e=e.crop({x:a,y:o,width:s,height:c})},X=e=>e*Math.PI/180,P=(e,t)=>(e.imageWidth=e.width,e.imageLength=e.height,Array.from({length:t},(t=>e))),C=(e,t,i=0)=>{const n=t.width,r=t.height,a=e.dimensions.width,o=[];for(let s=0;s<r;s++)for(let t=0;t<n;t++){const n=e.data[s].data[t+i*a];o.push(n)}return new Uint8Array(o)},R=(e,t,i=0)=>{const n=t.width,r=t.height,a=e.dimensions.width,o=[];for(let s=0;s<r;s++)for(let t=0;t<n;t++){const n=e.data[s].data[i+t*a];o.push(n)}return new Uint8Array(o)},I=(e,t)=>"left"==t?{width:e.dimensions.height,height:e.data.length,length:e.dimensions.width}:"top"==t?{width:e.dimensions.width,height:e.data.length,length:e.dimensions.height}:void 0,W=(e,t,i)=>new r(t,i,e,{kind:"GREY"}).rotateRight().flipX(),M=function(){let e=0;const t=[{strokeColor:"rgb(64, 196, 82)",highlightColor:"rgb(64, 196, 82, 0.3)"},{strokeColor:"rgb(255, 243, 33)",highlightColor:"rgb(255, 243, 33, 0.3)"},{strokeColor:"rgb(193, 63, 63)",highlightColor:"rgb(193, 63, 63, 0.3)"}];return{getNextColor:(i=!1)=>(e=i?(e+1)%t.length:0,t[e])}}(),D=(e,t,i,{isNested:n=!1}={})=>{const r=e.getContext("2d"),{highlightColor:a,strokeColor:o}=M.getNextColor(n);r.fillStyle=a,r.strokeStyle=o;const{x:s,y:c}=t,{w:l,h:d}=i;r.fillRect(s,c,l,d),r.strokeRect(s,c,l,d)},z=({imageData:e,width:t,height:i,canvasElement:n,imageRange:r=[0,255],colorScale:o="greys"})=>{const s=new a({canvas:n,data:e,width:t,height:i,domain:r,colorScale:o,useWebGL:!1});return s.render(),s};function k(e,t,i){return e+i*t}const q=e=>{const{data:t,imageWidth:i,imageLength:n}=e.data[0],r=t[k(0,0,i)],a=t[k(i,0,i)],o=t[k(0,n-1,i)],s=t[k(i-1,n-1,i)];if(0!==r||0!==a||0!==o||0!==s)return{isRotated:!1};let c=i;for(let u=i-1;u>=0&&0===t[k(u-1,0,i)];u--)c=u;let l=0;for(let u=1;u<=n&&0===t[k(i-1,u,i)];u++)l=u;if(c===i&&0===l)return{isRotated:!1};const d=i-c,h=.5*d*l;let g=0;for(let u=c;u<i;u++)for(let e=0;e<l;e++)0===t[k(u,e,i)]&&g++;if(g/h<.45)return{isRotated:!1};return{isRotated:!0,angle:180*Math.atan(l/d)/Math.PI}};let $=!0;const N=()=>{document.querySelector("#guide-text-container").style.display="block"},A=()=>{document.querySelector("#guide-text-container").style.display="none"},G=()=>{document.querySelector("#toggle-guide-text").innerHTML="Show Usage Guide"},U=()=>{document.querySelector("#toggle-guide-text").innerHTML="Hide Usage Guide"};!function(e={}){const{immediate:t=!1,onNeedRefresh:i,onOfflineReady:n}=e;let r;"serviceWorker"in navigator&&(r=new o("./sw.js",{scope:"./"}),r.addEventListener("activated",(e=>{e.isUpdate?window.location.reload():null==n||n()})),r.register({immediate:t}).then((e=>e)))}({onOfflineReady(){console.log("Working in offline mode.")}});const H={sourceImage:null,crop:null,mainCrop:null},O=E({callback:e=>{H.sourceImage=e,Q()}}),T=E({callback:e=>{H.crop=e,Q()}}),B=E({callback:e=>{if(null==H.crop||null==H.crop.position)return;if(H.crop.dimensions.width!=e.dimensions.width||H.crop.dimensions.height!=e.dimensions.height)return void(document.querySelector("#warning-text").style.display="block");document.querySelector("#warning-text").style.display="none";const t=document.querySelector("#replaced-crop-canvas"),i=H.sourceImage.data[H.crop.position.z-1];(async({imageData:e,width:t,height:i,canvasElement:n,imageRange:r=[0,255],colorScale:o="greys",cropPosition:s,cropDimensions:c,angle:l=null,newCrop:d})=>{const h=n.getContext("2d"),{x:g,y:u}=s,{width:p,height:m}=c,y=new a({canvas:n,data:e,width:t,height:i,domain:r,colorScale:o,useWebGL:!1});y.render();const v=document.createElement("canvas");new a({canvas:v,data:d.data[0].data,width:d.dimensions.width,height:d.dimensions.height,domain:r,colorScale:o,useWebGL:!1}).render();const f=v.getContext("2d"),w=await createImageBitmap(f.getImageData(0,0,d.dimensions.width,d.dimensions.height));if(h.save(),h.translate(g+p/2,u+m/2),null!=l&&h.rotate(X(l)),h.drawImage(w,-p/2,-m/2),h.restore(),null!=l){h.save();const e=await createImageBitmap(h.getImageData(g,u,p,m));h.translate(g+p/2,u+m/2),h.drawImage(e,-p/2,-m/2),h.restore()}document.querySelector("#replaced-crop-canvas").style.visibility="visible"})({imageData:i.data,width:i.imageWidth,height:i.imageLength,canvasElement:t,cropPosition:H.crop.position,cropDimensions:H.crop.dimensions,angle:H.crop.isRotated?H.crop.angle:null,newCrop:e})}});document.querySelector("#new-crop-input").addEventListener("change",B),document.querySelector("#source-image-input").addEventListener("change",O),document.querySelector("#crop-image-input").addEventListener("change",T),document.querySelector("#toggle-guide-text").addEventListener("click",(()=>{if($)return N(),U(),void($=!1);A(),G(),$=!0}));const j=e=>{const t=H.crop.data[0],i=((e,t,i,n,r=1)=>{let a=b(e,t,i,n);return a=S(a,n),P(a,r)})(t.data,t.imageWidth,t.imageLength,e,H.crop.data.length);H.crop={data:i,original:H.crop.original,dimensions:H.crop.dimensions,originalDimensions:H.crop.originalDimensions,angle:e,isRotated:!0}},Y=()=>{const e=((e,t,i,n,{width:a=150,height:o=150}={})=>{let s=new r(t,i,e,{kind:"GREY"});const c=Math.min(a,t),l=Math.min(o,i);return s=s.crop({x:0,y:0,width:c,height:l}),P(s,n)})(H.crop.data[0].data,H.crop.dimensions.width,H.crop.dimensions.height,H.crop.data.length,{width:150,height:150});H.crop={data:e,original:H.crop.original,dimensions:H.crop.dimensions,originalDimensions:H.crop.originalDimensions}},F=({position:e,sourceCanvas:t,isNested:i=!1})=>{const n={width:H.crop.data[0].imageWidth,height:H.crop.data[0].imageLength},{position:r}=((e,t,i)=>({position:{x:e.x-Math.round((i.width-t.width)/2),y:e.y-Math.round((i.height-t.height)/2),z:e.z},width:i.width,height:i.height}))(e,n,H.crop.dimensions);H.crop.position=r,D(t,r,{w:H.crop.dimensions.width,h:H.crop.dimensions.height},{isNested:i})},K=({position:e,sourceCanvas:t,isNested:i=!1})=>{const{position:n}=((e,t)=>({position:{x:e.x,y:e.y,z:e.z},width:t.width,height:t.height}))(e,H.crop.dimensions);H.crop.position=n,D(t,n,{w:H.crop.dimensions.width,h:H.crop.dimensions.height},{isNested:i})},V=({layers:e,layerFinished:t})=>{w(t/e)},_=(e,t=0)=>{H.crop=((e,t="left",i=0)=>{const n=I(e,t),r="top"==t?C(e,n,i):R(e,n,i);return{data:P(W(r,n.width,n.height),n.length),original:e.data,dimensions:n,originalDimensions:e.dimensions}})(H.crop,e,t)},J=async e=>{H.crop.data=H.crop.original,H.crop.dimensions=H.crop.originalDimensions,_(e);const t=q(H.crop);t.isRotated?j(t.angle):Y();return{imageRotatedInfo:t,results:await v(H.sourceImage,H.crop,{isRotated:t.isRotated,isResliced:!0,pipelineLayerCompleteCallback:V}),reslicedDirection:e}},Q=async()=>{if(null==H.sourceImage||null==H.crop)return;document.querySelector("#replaced-crop-canvas").style.visibility="hidden",document.querySelector("#info-area").style.visibility="visible",document.querySelector("#warning-text").style.display="none";const e=document.querySelector("#source-image-canvas");w(0);const t=((e,t)=>{const i=[];return null!=e&&null!=e||i.push("The source image provided is not defined"),null!=t&&null!=t||i.push("The cropped image provided is not defined"),(e.data.length<t.data.length||e.dimensions.width<t.dimensions.width||e.dimensions.height<t.dimensions.height)&&i.push("The source image provided is smaller than the cropped image"),e.data.length==t.data.length&&e.dimensions.width==t.dimensions.width&&e.dimensions.height==t.dimensions.height&&i.push("The crop provided is the same size as the source image"),i})(H.sourceImage,H.crop);if(x(t),t.length>0)return;const{errors:i,bestPosition:n,isRotated:r,reslicedDirection:a}=await(async()=>{let e=null,t=q(H.crop);t.isRotated?j(t.angle):Y();let i=await v(H.sourceImage,H.crop,{isRotated:t.isRotated,pipelineLayerCompleteCallback:V});if(null!=i.errors&&i.errors.length>0){const n=await J("top");t=n.imageRotatedInfo,i=n.results,e=n.reslicedDirection}if(null!=i.errors&&i.errors.length>0){const n=await J("left");t=n.imageRotatedInfo,i=n.results,e=n.reslicedDirection}return{errors:i.errors,bestPosition:i.bestPosition,isRotated:t.isRotated,reslicedDirection:e}})();if(x(i),null!=i&&i.length>0){const t=H.sourceImage.data[0];return void z({imageData:t.data,width:t.imageWidth,height:t.imageLength,canvasElement:e})}const o={x:n.x,y:n.y,z:n.z+1};H.crop.position=o,H.crop.reslicedDirection=a,null==H.mainCrop&&(H.mainCrop=H.crop);if(((e,t)=>{if(e.layer!=t.layer)return!1;const i=t.x<e.x&&t.y<e.y,n=t.x+t.width>e.x+e.width,r=t.y+t.height>e.y+e.height;return i&&n&&r})({x:H.crop.position.x,y:H.crop.position.y,layer:H.crop.position.z,width:H.crop.dimensions.width,height:H.crop.dimensions.height},{x:H.mainCrop.position.x,y:H.mainCrop.position.y,layer:H.mainCrop.position.z,width:H.mainCrop.dimensions.width,height:H.mainCrop.dimensions.height}))r?F({position:o,sourceCanvas:e,isNested:!0}):K({position:o,sourceCanvas:e,isNested:!0});else{H.mainCrop=H.crop;const t=H.sourceImage.data[o.z-1];z({imageData:t.data,width:t.imageWidth,height:t.imageLength,canvasElement:e}),r?F({position:o,sourceCanvas:e}):K({position:o,sourceCanvas:e})}Z(),await te()},Z=()=>{const e=`${H.crop.position.x}-${H.crop.position.x+H.crop.dimensions.width}`,t=`${H.crop.position.y}-${H.crop.position.y+H.crop.dimensions.height}`,i=`${H.crop.position.z}-${H.crop.position.z+H.crop.data.length}`,n=null!=H.crop.isRotated?`${Math.round(H.crop.angle)}`:"",r=null!=H.crop.reslicedDirection?`Resliced from: ${ee(H.crop.reslicedDirection)}`:"",a=`Crop Position: <br> x - ${e}, y - ${t}, z - ${i} ${null!=H.crop.isRotated?`<br> Rotated - ${n}°`:""} ${null!=H.crop.reslicedDirection?`<br> ${r}`:""}`;document.querySelector("#crop-info").innerHTML=a},ee=e=>e[0].toUpperCase()+e.slice(1),te=()=>{const e=document.querySelector("#crop-canvas"),t=H.sourceImage.data[H.crop.position.z-1];(async({imageData:e,width:t,height:i,canvasElement:n,imageRange:r=[0,255],colorScale:o="greys",cropPosition:s,cropDimensions:c,angle:l=null})=>{const d=n.getContext("2d"),{x:h,y:g}=s,{width:u,height:p}=c,[m,y]=[t,i],v=new a({canvas:n,data:e,width:t,height:i,domain:r,colorScale:o,useWebGL:!1});v.render(),d.fillStyle="rgb(0,0,0)",d.save();const f=await createImageBitmap(d.getImageData(h,g,u,p));if(d.fillRect(0,0,m,y),d.translate(h+u/2,g+p/2),null!=l&&d.rotate(X(l)),d.drawImage(f,-u/2,-p/2),d.restore(),null!=l){d.save();const e=await createImageBitmap(d.getImageData(h,g,u,p));d.fillRect(0,0,m,y),d.translate(h+u/2,g+p/2),d.drawImage(e,-u/2,-p/2),d.restore()}})({imageData:t.data,width:t.imageWidth,height:t.imageLength,canvasElement:e,cropPosition:H.crop.position,cropDimensions:H.crop.dimensions,angle:H.crop.isRotated?H.crop.angle:null})};
