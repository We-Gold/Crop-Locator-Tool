import{g as e,d as t,a as i,b as a,I as n,p as r}from"./vendor.a78a7e74.js";const o=new e.exports.GPU({mode:"gpu"});function s(e,t,i){return e+i*t}o.addFunction(s);const c=(e,t,i)=>{const a=Math.trunc(Math.abs(e.data[0].imageWidth-t.data[0].imageWidth)/i),n=Math.trunc(Math.abs(e.data[0].imageLength-t.data[0].imageLength)/i);return o.createKernel((function(e,t){const i=this.thread.x*this.constants.useEveryXPixel,a=this.thread.y*this.constants.useEveryXPixel;let n=0;for(let r=0;r<this.constants.cropLayerWidth;r+=this.constants.useEveryXPixel){const o=i+r;for(let r=0;r<this.constants.cropLayerLength;r+=this.constants.useEveryXPixel){const c=a+r,h=s(o,c,this.constants.sourceImageLayerWidth),d=s(o-i,c-a,this.constants.cropLayerWidth),l=e[h],g=t[d];n+=Math.abs(l-g)}}return n})).setOutput([a,n]).setConstants({sourceImageLayerWidth:e.data[0].imageWidth,cropLayerWidth:t.data[0].imageWidth,cropLayerLength:t.data[0].imageLength,useEveryXPixel:i})},h=(e,t,i,a,n,r,c)=>{const{xAxisScans:h,yAxisScans:d}=l(e,t,i,a);return o.createKernel((function(e,t){const i=this.thread.x*this.constants.useEveryXPixel+this.constants.originX,a=this.thread.y*this.constants.useEveryXPixel+this.constants.originY;let n=0;for(let r=0;r<this.constants.cropLayerWidth;r+=this.constants.useEveryXPixel){const o=i+r;for(let r=0;r<this.constants.cropLayerLength;r+=this.constants.useEveryXPixel){const c=a+r,h=s(o,c,this.constants.sourceImageLayerWidth),d=s(o-i,c-a,this.constants.cropLayerWidth),l=e[h],g=t[d];n+=Math.abs(l-g)}}return n})).setOutput([h,d]).setConstants({sourceImageLayerWidth:e.data[0].imageWidth,cropLayerWidth:t.data[0].imageWidth,cropLayerLength:t.data[0].imageLength,useEveryXPixel:n,originX:r,originY:c})},d=(e,t,i)=>Math.min(Math.max(e,t),i),l=(e,t,i,a)=>{const{useEveryXPixel:n,useEveryXLayer:r}=a(),o=Math.abs(e.data[0].imageWidth-t.data[0].imageWidth),s=d(i.x-n,0,o),c=d(i.x+n,0,o)-s,h=Math.abs(e.data[0].imageLength-t.data[0].imageLength),l=d(i.y-n,0,h),g=d(i.y+n,0,h)-l,u=Math.abs(e.data.length-t.data.length),m=d(i.z-r,0,u);return{xScanStart:s,xAxisScans:c,yScanStart:l,yAxisScans:g,zScanStart:m,zAxisScans:d(i.z+r,0,u)-m}},g=({result:e,crop:t,convertPosition:i,threshold:a=.1})=>{const{useEveryXPixel:n,useEveryXLayer:r}=i(),o=(({threshold:e=.1,cropWidth:t,cropHeight:i,range:a=[0,255],useEveryXPixel:n})=>e*Math.abs(a[0]-a[1])*Math.trunc(t/n*i/n))({threshold:a,cropWidth:t.data[0].imageWidth,cropHeight:t.data[0].imageLength,useEveryXPixel:n,useEveryXLayer:r}),s=[];for(const[c,h]of Object.entries(e))for(const[e,t]of Object.entries(h))for(const[i,a]of Object.entries(t))if(a<o){const t=[c,e,i].map((e=>parseInt(e)));s.push({difference:a,index:t})}if(0==s.length)return null;return s.map((e=>{const t=e.index;return Object.assign(i({x:t[2],y:t[1],z:t[0]}),{difference:e.difference})}))},u=(e,t,{useEveryXPixel:i,useEveryXLayer:a,threshold:n})=>{const[r,o]=((e,t,{useEveryXLayer:i,useEveryXPixel:a})=>{const n=c(e,t,a),r=Math.abs(e.data.length-t.data.length);let o=[];for(let s=0;s<=r;s+=i){const i=e.data[s],a=t.data[0];o.push(n(i.data,a.data))}return n.destroy(),[o,(e=null)=>null==e?{useEveryXPixel:a,useEveryXLayer:i}:{x:e.x*a,y:e.y*a,z:e.z*i}]})(e,t,{useEveryXPixel:i,useEveryXLayer:a});return[g({result:r,crop:t,convertPosition:o,threshold:n}),o,r]},m=(e,t,i,a,{useEveryXPixel:n,useEveryXLayer:r,threshold:o})=>{const[s,c]=((e,t,i,a,{useEveryXLayer:n,useEveryXPixel:r})=>{const o=i.map(((n,o)=>{const{xScanStart:s,yScanStart:c}=l(e,t,i[o],a);return h(e,t,n,a,r,s,c)})).map(((r,o)=>{const{zScanStart:s,zAxisScans:c}=l(e,t,i[o],a);let h=[];for(let i=s;i<=s+c;i+=n){const a=e.data[i],n=t.data[0];h.push(r(a.data,n.data))}return r.destroy(),h})),{zScanStart:s,xScanStart:c,yScanStart:d}=l(e,t,i[0],a);return[o,(e=null)=>null==e?{useEveryXPixel:r,useEveryXLayer:n}:{x:e.x*r+c,y:e.y*r+d,z:e.z*n+s}]})(e,t,i,a,{useEveryXPixel:n,useEveryXLayer:r});return[s.map((e=>g({result:e,crop:t,convertPosition:c,threshold:o}))).reduce(((e,t)=>e.concat(t)),[]),c,s]},p=e=>e.reduce(((e,t)=>null==t?e:t.difference<e.difference?t:e),{difference:Number.MAX_VALUE}),y=async(e,t,{isRotated:i=!1,pipelineLayerCompleteCallback:a=null}={})=>{const n=v(t),r=[{useEveryXPixel:n,useEveryXLayer:50,threshold:.1},{useEveryXPixel:n,useEveryXLayer:5,threshold:.06},{useEveryXPixel:1,useEveryXLayer:1,threshold:.01}],o=[{useEveryXPixel:n,useEveryXLayer:50,threshold:.1},{useEveryXPixel:1,useEveryXLayer:1,threshold:.03}],{errors:s,pipeline:c,bestPosition:h}=await((e,t,i,a=null)=>{const n=[];let r=0;return new Promise((o=>{const s=setInterval((()=>{if(r==i.length)return clearInterval(s),void o({pipeline:n,bestPosition:p(n[n.length-1][0])});if(r>n.length)return;const{useEveryXPixel:c,useEveryXLayer:h,threshold:d}=i[r];if(0===r){const[o,s,l]=u(e,t,{useEveryXPixel:c,useEveryXLayer:h,threshold:d});return n.push([o,s,l]),null!=a&&a({layers:i.length,layerFinished:r+1}),void r++}if(null==n[r-1][0]||0===n[r-1][0].length)return clearInterval(s),void o({errors:["No match found"]});if(!n[r-1][0].some((e=>null!=e)))return clearInterval(s),void o({errors:["No match found"]});const l=[p(n[r-1][0])],[g,y,v]=m(e,t,l,n[r-1][1],{useEveryXPixel:c,useEveryXLayer:h,threshold:d});n.push([g,y,v]),null!=a&&a({layers:i.length,layerFinished:r+1}),r++}),0)}))})(e,t,i?o:r,a);return{errors:s,pipeline:c,bestPosition:h}},v=e=>e.data[0].imageWidth<=25?1:e.data[0].imageWidth<=75?5:10,f=e=>{document.querySelector("#progress-bar > div").style.width=`${Math.round(100*e)}%`},w=e=>{null!=e&&null!=e&&e.forEach((e=>(e=>{document.querySelector("#crop-info").innerHTML=`<span>${e}</span>`,f(1)})(e)))},x=async({imagePath:e=null,arrayBuffer:n=null})=>{if(null==e&&null==n)return{errors:["No image provided"]};if(null!=e){const t=(e=>{const t=[];return null!=e&&null!=e||t.push("No image path provided"),t})(e);if(0!=t.length)return{errors:t};n=await(async e=>{const t=await i.get(e,{responseType:"arraybuffer"});return a.Buffer.from(t.data,"utf-8")})(e)}let r;try{r=t(n)}catch(o){return{errors:["An image provided is not a tiff. Currently this tool only accepts tiffs."]}}return{data:r}},L=({errorHandler:e=w,callback:t})=>async i=>{const a=i.target.files[0],n=await a.arrayBuffer(),{data:r,errors:o}=await x({arrayBuffer:n,getImageDimensions:async()=>{const e=window.URL.createObjectURL(a);return await(e=>new Promise((t=>{const i=new Image;i.onload=()=>{t({imageHeight:i.height,imageWidth:i.width})},i.src=e})))(e)}});e(o),null!=r&&t({data:r,original:r,dimensions:{width:r[0].imageWidth,height:r[0].imageLength},originalDimensions:{width:r[0].imageWidth,height:r[0].imageLength}})},E=(e,t,i,a)=>{let r=new n(t,i,e,{kind:"GREY"});return r=r.rotate(-a,{interpolation:"bilinear"}),r},X=(e,t)=>{const i=e.parent.width,a=Math.abs(i*Math.sin(S(t))),n=a/(Math.abs(i*Math.cos(S(t)))+a)*i,r=Math.trunc(n*Math.cos(S(t))),o=Math.trunc(a-n*Math.sin(S(t))),s=e.width-o-r,c=e.height-r-o;return e=e.crop({x:r,y:o,width:s,height:c})},S=e=>e*Math.PI/180,P=(e,t)=>(e.imageWidth=e.width,e.imageLength=e.height,Array.from({length:t},(t=>e))),b=(e,t,i=0)=>{const a=t.width,n=t.height,r=e.dimensions.width,o=[];for(let s=0;s<n;s++)for(let t=0;t<a;t++){const a=e.data[s].data[t+i*r];o.push(a)}return new Uint8Array(o)},I=(e,t,i=0)=>{const a=t.width,n=t.height,r=e.dimensions.width,o=[];for(let s=0;s<n;s++)for(let t=0;t<a;t++){const a=e.data[s].data[i+t*r];o.push(a)}return new Uint8Array(o)},W=(e,t)=>"left"==t?{width:e.dimensions.height,height:e.data.length,length:e.dimensions.width}:"top"==t?{width:e.dimensions.width,height:e.data.length,length:e.dimensions.height}:void 0,R=(e,t,i)=>new n(t,i,e,{kind:"GREY"}).rotateRight().flipX(),M=(e,t,i,{strokeColor:a="rgb(64, 196, 82)",highlightColor:n="rgba(64, 196, 82, 0.3)"}={})=>{const r=e.getContext("2d");r.fillStyle=n,r.strokeStyle=a;const{x:o,y:s}=t,{w:c,h:h}=i;r.fillRect(o,s,c,h),r.strokeRect(o,s,c,h)},z=({imageData:e,width:t,height:i,canvasElement:a,imageRange:n=[0,255],colorScale:o="greys"})=>{const s=new r({canvas:a,data:e,width:t,height:i,domain:n,colorScale:o,useWebGL:!1});return s.render(),s};function D(e,t,i){return e+i*t}const C=e=>{const{data:t,imageWidth:i,imageLength:a}=e.data[0],n=t[D(0,0,i)],r=t[D(i,0,i)],o=t[D(0,a-1,i)],s=t[D(i-1,a-1,i)];if(0!==n||0!==r||0!==o||0!==s)return{isRotated:!1};let c=i;for(let u=i-1;u>=0&&0===t[D(u-1,0,i)];u--)c=u;let h=0;for(let u=1;u<=a&&0===t[D(i-1,u,i)];u++)h=u;if(c===i&&0===h)return{isRotated:!1};const d=i-c,l=.5*d*h;let g=0;for(let u=c;u<i;u++)for(let e=0;e<h;e++)0===t[D(u,e,i)]&&g++;if(g/l<.45)return{isRotated:!1};return{isRotated:!0,angle:180*Math.atan(h/d)/Math.PI}};let q=!0;const k=()=>{document.querySelector("#guide-text-container").style.display="block"},$=()=>{document.querySelector("#guide-text-container").style.display="none"},A=()=>{document.querySelector("#toggle-guide-text").innerHTML="Show Usage Guide"},G=()=>{document.querySelector("#toggle-guide-text").innerHTML="Hide Usage Guide"},H={sourceImage:null,crop:null},T=L({callback:e=>{H.sourceImage=e,V()}}),B=L({callback:e=>{H.crop=e,V()}}),U=L({callback:e=>{if(null==H.crop||null==H.crop.position)return;if(H.crop.dimensions.width!=e.dimensions.width||H.crop.dimensions.height!=e.dimensions.height)return;const t=document.querySelector("#replaced-crop-canvas"),i=H.sourceImage.data[H.crop.position.z-1];(async({imageData:e,width:t,height:i,canvasElement:a,imageRange:n=[0,255],colorScale:o="greys",cropPosition:s,cropDimensions:c,angle:h=null,newCrop:d})=>{const l=a.getContext("2d"),{x:g,y:u}=s,{width:m,height:p}=c,y=new r({canvas:a,data:e,width:t,height:i,domain:n,colorScale:o,useWebGL:!1});y.render();const v=document.createElement("canvas");new r({canvas:v,data:d.data[0].data,width:d.dimensions.width,height:d.dimensions.height,domain:n,colorScale:o,useWebGL:!1}).render();const f=v.getContext("2d"),w=await createImageBitmap(f.getImageData(0,0,d.dimensions.width,d.dimensions.height));if(l.save(),l.translate(g+m/2,u+p/2),null!=h&&l.rotate(S(h)),l.drawImage(w,-m/2,-p/2),l.restore(),null!=h){l.save();const e=await createImageBitmap(l.getImageData(g,u,m,p));l.translate(g+m/2,u+p/2),l.drawImage(e,-m/2,-p/2),l.restore()}document.querySelector("#replaced-crop-canvas").style.visibility="visible"})({imageData:i.data,width:i.imageWidth,height:i.imageLength,canvasElement:t,cropPosition:H.crop.position,cropDimensions:H.crop.dimensions,angle:H.crop.isRotated?H.crop.angle:null,newCrop:e})}});document.querySelector("#new-crop-input").addEventListener("change",U),document.querySelector("#source-image-input").addEventListener("change",T),document.querySelector("#crop-image-input").addEventListener("change",B),document.querySelector("#toggle-guide-text").addEventListener("click",(()=>{if(q)return k(),G(),void(q=!1);$(),A(),q=!0}));const O=e=>{const t=H.crop.data[0],i=((e,t,i,a,n=1)=>{let r=E(e,t,i,a);return r=X(r,a),P(r,n)})(t.data,t.imageWidth,t.imageLength,e,H.crop.data.length);H.crop={data:i,original:H.crop.original,dimensions:H.crop.dimensions,originalDimensions:H.crop.originalDimensions,angle:e,isRotated:!0}},j=()=>{const e=((e,t,i,a,{width:r=150,height:o=150}={})=>{let s=new n(t,i,e,{kind:"GREY"});const c=Math.min(r,t),h=Math.min(o,i);return s=s.crop({x:0,y:0,width:c,height:h}),P(s,a)})(H.crop.data[0].data,H.crop.dimensions.width,H.crop.dimensions.height,H.crop.data.length,{width:150,height:150});H.crop={data:e,original:H.crop.original,dimensions:H.crop.dimensions,originalDimensions:H.crop.originalDimensions}},N=({position:e,sourceCanvas:t})=>{const i={width:H.crop.data[0].imageWidth,height:H.crop.data[0].imageLength},{position:a}=((e,t,i)=>({position:{x:e.x-Math.round((i.width-t.width)/2),y:e.y-Math.round((i.height-t.height)/2),z:e.z},width:i.width,height:i.height}))(e,i,H.crop.dimensions);H.crop.position=a,M(t,a,{w:H.crop.dimensions.width,h:H.crop.dimensions.height})},Y=({layers:e,layerFinished:t})=>{f(t/e)},F=(e,t=0)=>{H.crop=((e,t="left",i=0)=>{const a=W(e,t),n="top"==t?b(e,a,i):I(e,a,i);return{data:P(R(n,a.width,a.height),a.length),original:e.data,dimensions:a,originalDimensions:e.dimensions}})(H.crop,e,t)},K=async e=>{H.crop.data=H.crop.original,H.crop.dimensions=H.crop.originalDimensions,F(e);const t=C(H.crop);t.isRotated?O(t.angle):j();return{imageRotatedInfo:t,results:await y(H.sourceImage,H.crop,{isRotated:t.isRotated,isResliced:!0,pipelineLayerCompleteCallback:Y})}},V=async()=>{if(null==H.sourceImage||null==H.crop)return;document.querySelector("#replaced-crop-canvas").style.visibility="hidden",document.querySelector("#info-area").style.visibility="visible",f(0);const e=document.querySelector("#source-image-canvas"),t=H.sourceImage.data[0];z({imageData:t.data,width:t.imageWidth,height:t.imageLength,canvasElement:e});const i=((e,t)=>{const i=[];return null!=e&&null!=e||i.push("The source image provided is not defined"),null!=t&&null!=t||i.push("The cropped image provided is not defined"),(e.data.length<t.data.length||e.dimensions.width<t.dimensions.width||e.dimensions.height<t.dimensions.height)&&i.push("The source image provided is smaller than the cropped image"),e.data.length==t.data.length&&e.dimensions.width==t.dimensions.width&&e.dimensions.height==t.dimensions.height&&i.push("The crop provided is the same size as the source image"),i})(H.sourceImage,H.crop);if(w(i),i.length>0)return;const{errors:a,bestPosition:n,isRotated:r}=await(async()=>{let e=C(H.crop);e.isRotated?O(e.angle):j();let t=await y(H.sourceImage,H.crop,{isRotated:e.isRotated,pipelineLayerCompleteCallback:Y});if(null!=t.errors&&t.errors.length>0){const i=await K("top");e=i.imageRotatedInfo,t=i.results}if(null!=t.errors&&t.errors.length>0){const i=await K("left");e=i.imageRotatedInfo,t=i.results}return{errors:t.errors,bestPosition:t.bestPosition,isRotated:e.isRotated}})();if(w(a),null!=a&&a.length>0)return;const o={x:n.x,y:n.y,z:n.z+1};H.crop.position=o;const s=H.sourceImage.data[o.z-1];z({imageData:s.data,width:s.imageWidth,height:s.imageLength,canvasElement:e}),r?N({position:o,sourceCanvas:e}):(({position:e,sourceCanvas:t})=>{const{position:i}=((e,t)=>({position:{x:e.x,y:e.y,z:e.z},width:t.width,height:t.height}))(e,H.crop.dimensions);H.crop.position=i,M(t,i,{w:H.crop.dimensions.width,h:H.crop.dimensions.height})})({position:o,sourceCanvas:e}),_(),await J()},_=()=>{const e=`${H.crop.position.x}-${H.crop.position.x+H.crop.dimensions.width}`,t=`${H.crop.position.y}-${H.crop.position.y+H.crop.dimensions.height}`,i=`${H.crop.position.z}-${H.crop.position.z+H.crop.data.length}`,a=null!=H.crop.isRotated?`${Math.round(H.crop.angle)}`:"",n=`Crop Position: <br> x - ${e}, y - ${t}, z - ${i} ${null!=H.crop.isRotated?`<br> Rotated - ${a}°`:""}`;document.querySelector("#crop-info").innerHTML=n},J=()=>{const e=document.querySelector("#crop-canvas"),t=H.sourceImage.data[H.crop.position.z-1];(async({imageData:e,width:t,height:i,canvasElement:a,imageRange:n=[0,255],colorScale:o="greys",cropPosition:s,cropDimensions:c,angle:h=null})=>{const d=a.getContext("2d"),{x:l,y:g}=s,{width:u,height:m}=c,[p,y]=[t,i],v=new r({canvas:a,data:e,width:t,height:i,domain:n,colorScale:o,useWebGL:!1});v.render(),d.fillStyle="rgb(0,0,0)",d.save();const f=await createImageBitmap(d.getImageData(l,g,u,m));if(d.fillRect(0,0,p,y),d.translate(l+u/2,g+m/2),null!=h&&d.rotate(S(h)),d.drawImage(f,-u/2,-m/2),d.restore(),null!=h){d.save();const e=await createImageBitmap(d.getImageData(l,g,u,m));d.fillRect(0,0,p,y),d.translate(l+u/2,g+m/2),d.drawImage(e,-u/2,-m/2),d.restore()}})({imageData:t.data,width:t.imageWidth,height:t.imageLength,canvasElement:e,cropPosition:H.crop.position,cropDimensions:H.crop.dimensions,angle:H.crop.isRotated?H.crop.angle:null})};
