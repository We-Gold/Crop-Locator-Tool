import{g as e,d as t,a,b as r,p as n,I as i}from"./vendor.6053f2ee.js";const s=new e.exports.GPU({mode:"gpu"});function o(e,t,a){return e+a*t}function h(e,t,a,r,n,i,s,h){let l=0;for(let c=a;c<a+i;c+=h)for(let d=r;d<r+s;d+=h){const s=o(c,d,n),h=o(c-a,d-r,i),u=e[s],g=t[h];l+=Math.abs(u-g)}return l}s.addFunction(o),s.addFunction(h);const l=(e,t,a)=>{const r=Math.trunc(Math.abs(e.data[0].imageWidth-t.data[0].imageWidth)/a),n=Math.trunc(Math.abs(e.data[0].imageLength-t.data[0].imageLength)/a);return s.createKernel((function(e,t,a){const[r,n,i,s]=a;return h(e,t,this.thread.x*s,this.thread.y*s,r,n,i,s)})).setOutput([r,n])},c=(e,t,a)=>Math.min(Math.max(e,t),a),d=(e,t,a,r)=>{const{useEveryXPixel:n,useEveryXLayer:i}=r(),s=Math.abs(e.data[0].imageWidth-t.data[0].imageWidth),o=c(a.x-n,0,s),h=c(a.x+n,0,s)-o,l=Math.abs(e.data[0].imageLength-t.data[0].imageLength),d=c(a.y-n,0,l),u=c(a.y+n,0,l)-d,g=Math.abs(e.data.length-t.data.length),m=c(a.z-i,0,g);return{xScanStart:o,xAxisScans:h,yScanStart:d,yAxisScans:u,zScanStart:m,zAxisScans:c(a.z+i,0,g)-m}},u=(e,t,a,r)=>{const{xAxisScans:n,yAxisScans:i}=d(e,t,a,r);return s.createKernel((function(e,t,a){const[r,n,i,s,o,l]=a;return h(e,t,this.thread.x+o,this.thread.y+l,r,n,i,s)})).setOutput([n,i])},g=(e,t,a,r=0,n=0)=>{const i=e.data[0],s=t.data[0];return[i.imageWidth,s.imageWidth,s.imageLength,a,r,n]},m=({result:e,crop:t,convertPosition:a,threshold:r=.1})=>{const{useEveryXPixel:n,useEveryXLayer:i}=a(),s=(({threshold:e=.1,cropWidth:t,cropHeight:a,range:r=[0,255],useEveryXPixel:n})=>e*Math.abs(r[0]-r[1])*Math.trunc(t/n*a/n))({threshold:r,cropWidth:t.data[0].imageWidth,cropHeight:t.data[0].imageLength,useEveryXPixel:n,useEveryXLayer:i}),o=[];for(const[h,l]of Object.entries(e))for(const[e,t]of Object.entries(l))for(const[a,r]of Object.entries(t))if(r<s){const t=[h,e,a].map((e=>parseInt(e)));o.push({difference:r,index:t})}if(0==o.length)return null;return o.map((e=>{const t=e.index;return Object.assign(a({x:t[2],y:t[1],z:t[0]}),{difference:e.difference})}))},y=(e,t,{useEveryXPixel:a,useEveryXLayer:r,threshold:n})=>{const[i,s]=((e,t,{useEveryXLayer:a,useEveryXPixel:r})=>{const n=l(e,t,r),i=g(e,t,r),s=Math.abs(e.data.length-t.data.length);let o=[];for(let h=0;h<=s;h+=a){const a=e.data[h],r=t.data[0];o.push(n(a.data,r.data,i))}return[o,(e=null)=>null==e?{useEveryXPixel:r,useEveryXLayer:a}:{x:e.x*r,y:e.y*r,z:e.z*a}]})(e,t,{useEveryXPixel:a,useEveryXLayer:r});return[m({result:i,crop:t,convertPosition:s,threshold:n}),s,i]},p=(e,t,a,r,{useEveryXPixel:n,useEveryXLayer:i,threshold:s})=>{const[o,h]=((e,t,a,r,{useEveryXLayer:n,useEveryXPixel:i})=>{const s=a.map((a=>u(e,t,a,r))).map(((s,o)=>{const{zScanStart:h,zAxisScans:l,xScanStart:c,yScanStart:u}=d(e,t,a[o],r),m=g(e,t,i,c,u);let y=[];for(let a=h;a<=h+l;a+=n){const r=e.data[a],n=t.data[0];y.push(s(r.data,n.data,m))}return y})),{zScanStart:o,xScanStart:h,yScanStart:l}=d(e,t,a[0],r);return[s,(e=null)=>null==e?{useEveryXPixel:i,useEveryXLayer:n}:{x:e.x*i+h,y:e.y*i+l,z:e.z*n+o}]})(e,t,a,r,{useEveryXPixel:n,useEveryXLayer:i});return[o.map((e=>m({result:e,crop:t,convertPosition:h,threshold:s}))).reduce(((e,t)=>e.concat(t)),[]),h,o]},f=e=>e.reduce(((e,t)=>null==t?e:t.difference<e.difference?t:e),{difference:Number.MAX_VALUE}),v=(e,t,a=!1)=>{const r=((e,t)=>{const a=[];return null!=e&&null!=e||a.push("The source image provided is not defined"),null!=t&&null!=t||a.push("The cropped image provided is not defined"),(e.data.length<t.data.length||e.data[0].imageWidth<t.data[0].imageWidth||e.data[0].imageLength<t.data[0].imageLength)&&a.push("The source image provided is smaller than the cropped image"),a})(e,t);if(r.length>0)return{errors:r};console.time("pipeline");const{errors:n,pipeline:i,positions:s,bestPosition:o}=((e,t,a)=>{const r=[];for(const[n,i]of a.entries()){const{useEveryXPixel:a,useEveryXLayer:s,threshold:o}=i;if(0===n){const[n,i,h]=y(e,t,{useEveryXPixel:a,useEveryXLayer:s,threshold:o});r.push([n,i,h]);continue}if(null==r[n-1][0]||0===r[n-1][0].length)return{errors:["No match found"]};if(!r[n-1][0].some((e=>null!=e)))return{errors:["No match found"]};const h=[f(r[n-1][0])],[l,c,d]=p(e,t,h,r[n-1][1],{useEveryXPixel:a,useEveryXLayer:s,threshold:o});r.push([l,c,d])}return{pipeline:r,positions:r[r.length-1],bestPosition:f(r[r.length-1][0])}})(e,t,[{useEveryXPixel:5,useEveryXLayer:50,threshold:.1},{useEveryXPixel:1,useEveryXLayer:5,threshold:.06},{useEveryXPixel:1,useEveryXLayer:1,threshold:a?.03:.01}]);return console.timeEnd("pipeline"),{errors:n,pipeline:i,positions:s,bestPosition:o}},x=e=>{null!=e&&null!=e&&e.forEach((e=>(e=>{console.error(e)})(e)))},E=async({imagePath:e=null,arrayBuffer:n=null,getImageDimensions:i=null})=>{if(null==e&&null==n)return{errors:["No image provided"]};if(null!=e){const t=(e=>{const t=[];return null!=e&&null!=e||t.push("No image path provided"),t})(e);if(0!=t.length)return{errors:t};n=await(async e=>{const t=await a.get(e,{responseType:"arraybuffer"});return r.Buffer.from(t.data,"utf-8")})(e)}let s;try{s=t(n)}catch(o){return{errors:["An image provided is not a tiff. Currently this tool only accepts tiffs."]}}return{data:s}},L=({errorHandler:e=x,callback:t})=>async a=>{const r=a.target.files[0],n=await r.arrayBuffer(),{data:i,errors:s}=await E({arrayBuffer:n,getImageDimensions:async()=>{const e=window.URL.createObjectURL(r);return await(e=>new Promise((t=>{const a=new Image;a.onload=()=>{t({imageHeight:a.height,imageWidth:a.width})},a.src=e})))(e)}});e(s),null!=i&&t({data:i})},w=(e,t,a)=>{e.style.width=`${t}px`,e.style.height=`${a}px`},X=(e,t,a,{strokeColor:r="rgb(64, 196, 82)",highlightColor:n="rgba(64, 196, 82, 0.3)"}={})=>{const i=e.getContext("2d");i.fillStyle=n,i.strokeStyle=r;const{x:s,y:o}=t,{w:h,h:l}=a;i.fillRect(s,o,h,l),i.strokeRect(s,o,h,l)},S=({imageData:e,width:t,height:a,canvasElement:r,canvasWidth:i=null,canvasHeight:s=null,imageRange:o=[0,255],colorScale:h="greys"})=>{const l=new n({canvas:r,data:e,width:t,height:a,domain:o,colorScale:h,useWebGL:!1});return(({canvasElement:e,canvasWidth:t=null,canvasHeight:a=null,width:r,height:n})=>{if(null==t&&null==a)return;const i=r/n;if(null!=t)return void w(e,t,t/i);w(e,t*i,a)})({canvasElement:r,canvasWidth:i,canvasHeight:s,width:t,height:a}),l.render(),l};function b(e,t,a){return e+a*t}const P=(e,t,a,r)=>{let n=new i(t,a,e,{kind:"GREY"});return n=n.rotate(-r,{interpolation:"bilinear"}),n},W=(e,t)=>{const a=e.parent.width,r=Math.abs(a*Math.sin(M(t))),n=r/(Math.abs(a*Math.cos(M(t)))+r)*a,i=n*Math.cos(M(t)),s=r-n*Math.sin(M(t)),o=e.width-s-i,h=e.height-i-s;return e=e.crop({x:i,y:s,width:o,height:h})},M=e=>e*Math.PI/180,z=(e,t)=>(e.imageWidth=e.width,e.imageLength=e.height,Array.from({length:t},(t=>e))),I={sourceImage:null,crop:null},_=()=>{if(console.log(I),null==I.sourceImage||null==I.crop)return;const{isRotated:e,angle:t}=(e=>{const{data:t,imageWidth:a,imageLength:r}=e.data[0],n=t[b(0,0,a)],i=t[b(a,0,a)],s=t[b(0,r-1,a)],o=t[b(a-1,r-1,a)];if(0!==n||0!==i||0!==s||0!==o)return{isRotated:!1};let h=a;for(let g=a-1;g>=0&&0===t[b(g-1,0,a)];g--)h=g;let l=0;for(let g=1;g<=r&&0===t[b(a-1,g,a)];g++)l=g;if(h===a&&0===l)return{isRotated:!1};const c=a-h,d=.5*c*l;let u=0;for(let g=h;g<a;g++)for(let e=0;e<l;e++)0===t[b(g,e,a)]&&u++;return u/d<.45?{isRotated:!1}:{isRotated:!0,angle:180*Math.atan(l/c)/Math.PI}})(I.crop);if(e){const e=I.crop.data[0],a=((e,t,a,r,n=1)=>{let i=P(e,t,a,r);return i=W(i,r),z(i,n)})(e.data,e.imageWidth,e.imageLength,t,I.crop.data.length);I.crop={data:a,dimensions:{width:e.imageWidth,height:e.imageLength}}}(e=>{const t=e.data[0],a=document.querySelector("#crop-image-canvas");S({imageData:t.data,width:t.imageWidth,height:t.imageLength,canvasElement:a})})(I.crop);const{errors:a,pipeline:r,positions:n,bestPosition:i}=v(I.sourceImage,I.crop,e);x(a);const s=document.querySelector("#source-image-canvas"),o=I.sourceImage.data[0];if(S({imageData:o.data,width:o.imageWidth,height:o.imageLength,canvasElement:s}),null!=a&&a.length>0)return;const h={x:i.x,y:i.y,z:i.z+1},l=I.sourceImage.data[h.z];if(S({imageData:l.data,width:l.imageWidth,height:l.imageLength,canvasElement:s}),e){const e={width:I.crop.data[0].imageWidth,height:I.crop.data[0].imageLength},{position:t,width:a,height:r}=((e,t,a)=>({position:{x:e.x-(a.width-t.width)/2,y:e.y-(a.height-t.height)/2},width:a.width,height:a.height}))(h,e,I.crop.dimensions);X(s,t,{w:a,h:r})}else X(s,h,{w:I.crop.data[0].imageWidth,h:I.crop.data[0].imageLength})},R=L({callback:e=>{I.sourceImage=e,_()}}),A=L({callback:e=>{I.crop=e,_()}});document.querySelector("#source-image-input").addEventListener("change",R),document.querySelector("#crop-image-input").addEventListener("change",A),document.querySelector("#default-images-button").addEventListener("click",(async()=>{const{data:e,errors:t}=await E({imagePath:"/samples/5dpf_1_8bit.tif"}),{data:a,errors:r}=await E({imagePath:"/samples/Training Crops/5dpf_1_8bit_x_200-500_y_250-550_z_350-650_Rotated_30deg.tif"});x(t),x(r),I.sourceImage={data:e},I.crop={data:a},_()}));
