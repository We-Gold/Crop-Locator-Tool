import{g as e,d as t,a,b as n,I as i,p as r}from"./vendor.a78a7e74.js";const o=new e.exports.GPU({mode:"gpu"});function s(e,t,a){return e+a*t}o.addFunction(s);const c=(e,t,a)=>{const n=Math.trunc(Math.abs(e.data[0].imageWidth-t.data[0].imageWidth)/a),i=Math.trunc(Math.abs(e.data[0].imageLength-t.data[0].imageLength)/a);return o.createKernel((function(e,t){const a=this.thread.x*this.constants.useEveryXPixel,n=this.thread.y*this.constants.useEveryXPixel;let i=0;for(let r=0;r<this.constants.cropLayerWidth;r+=this.constants.useEveryXPixel){const o=a+r;for(let r=0;r<this.constants.cropLayerLength;r+=this.constants.useEveryXPixel){const c=n+r,h=s(o,c,this.constants.sourceImageLayerWidth),d=s(o-a,c-n,this.constants.cropLayerWidth),l=e[h],u=t[d];i+=Math.abs(l-u)}}return i})).setOutput([n,i]).setConstants({sourceImageLayerWidth:e.data[0].imageWidth,cropLayerWidth:t.data[0].imageWidth,cropLayerLength:t.data[0].imageLength,useEveryXPixel:a})},h=(e,t,a,n,i,r,c)=>{const{xAxisScans:h,yAxisScans:d}=l(e,t,a,n);return o.createKernel((function(e,t){const a=this.thread.x*this.constants.useEveryXPixel+this.constants.originX,n=this.thread.y*this.constants.useEveryXPixel+this.constants.originY;let i=0;for(let r=0;r<this.constants.cropLayerWidth;r+=this.constants.useEveryXPixel){const o=a+r;for(let r=0;r<this.constants.cropLayerLength;r+=this.constants.useEveryXPixel){const c=n+r,h=s(o,c,this.constants.sourceImageLayerWidth),d=s(o-a,c-n,this.constants.cropLayerWidth),l=e[h],u=t[d];i+=Math.abs(l-u)}}return i})).setOutput([h,d]).setConstants({sourceImageLayerWidth:e.data[0].imageWidth,cropLayerWidth:t.data[0].imageWidth,cropLayerLength:t.data[0].imageLength,useEveryXPixel:i,originX:r,originY:c})},d=(e,t,a)=>Math.min(Math.max(e,t),a),l=(e,t,a,n)=>{const{useEveryXPixel:i,useEveryXLayer:r}=n(),o=Math.abs(e.data[0].imageWidth-t.data[0].imageWidth),s=d(a.x-i,0,o),c=d(a.x+i,0,o)-s,h=Math.abs(e.data[0].imageLength-t.data[0].imageLength),l=d(a.y-i,0,h),u=d(a.y+i,0,h)-l,g=Math.abs(e.data.length-t.data.length),m=d(a.z-r,0,g);return{xScanStart:s,xAxisScans:c,yScanStart:l,yAxisScans:u,zScanStart:m,zAxisScans:d(a.z+r,0,g)-m}},u=({result:e,crop:t,convertPosition:a,threshold:n=.1})=>{const{useEveryXPixel:i,useEveryXLayer:r}=a(),o=(({threshold:e=.1,cropWidth:t,cropHeight:a,range:n=[0,255],useEveryXPixel:i})=>e*Math.abs(n[0]-n[1])*Math.trunc(t/i*a/i))({threshold:n,cropWidth:t.data[0].imageWidth,cropHeight:t.data[0].imageLength,useEveryXPixel:i,useEveryXLayer:r}),s=[];for(const[c,h]of Object.entries(e))for(const[e,t]of Object.entries(h))for(const[a,n]of Object.entries(t))if(n<o){const t=[c,e,a].map((e=>parseInt(e)));s.push({difference:n,index:t})}if(0==s.length)return null;return s.map((e=>{const t=e.index;return Object.assign(a({x:t[2],y:t[1],z:t[0]}),{difference:e.difference})}))},g=(e,t,{useEveryXPixel:a,useEveryXLayer:n,threshold:i})=>{const[r,o]=((e,t,{useEveryXLayer:a,useEveryXPixel:n})=>{const i=c(e,t,n),r=Math.abs(e.data.length-t.data.length);let o=[];for(let s=0;s<=r;s+=a){const a=e.data[s],n=t.data[0];o.push(i(a.data,n.data))}return i.destroy(),[o,(e=null)=>null==e?{useEveryXPixel:n,useEveryXLayer:a}:{x:e.x*n,y:e.y*n,z:e.z*a}]})(e,t,{useEveryXPixel:a,useEveryXLayer:n});return[u({result:r,crop:t,convertPosition:o,threshold:i}),o,r]},m=(e,t,a,n,{useEveryXPixel:i,useEveryXLayer:r,threshold:o})=>{const[s,c]=((e,t,a,n,{useEveryXLayer:i,useEveryXPixel:r})=>{const o=a.map(((i,o)=>{const{xScanStart:s,yScanStart:c}=l(e,t,a[o],n);return h(e,t,i,n,r,s,c)})).map(((r,o)=>{const{zScanStart:s,zAxisScans:c}=l(e,t,a[o],n);let h=[];for(let a=s;a<=s+c;a+=i){const n=e.data[a],i=t.data[0];h.push(r(n.data,i.data))}return r.destroy(),h})),{zScanStart:s,xScanStart:c,yScanStart:d}=l(e,t,a[0],n);return[o,(e=null)=>null==e?{useEveryXPixel:r,useEveryXLayer:i}:{x:e.x*r+c,y:e.y*r+d,z:e.z*i+s}]})(e,t,a,n,{useEveryXPixel:i,useEveryXLayer:r});return[s.map((e=>u({result:e,crop:t,convertPosition:c,threshold:o}))).reduce(((e,t)=>e.concat(t)),[]),c,s]},p=e=>e.reduce(((e,t)=>null==t?e:t.difference<e.difference?t:e),{difference:Number.MAX_VALUE}),y=async(e,t,{isRotated:a=!1,pipelineLayerCompleteCallback:n=null}={})=>{const i=v(t),r=[{useEveryXPixel:i,useEveryXLayer:50,threshold:.1},{useEveryXPixel:i,useEveryXLayer:5,threshold:.06},{useEveryXPixel:1,useEveryXLayer:1,threshold:.01}],o=[{useEveryXPixel:i,useEveryXLayer:50,threshold:.1},{useEveryXPixel:1,useEveryXLayer:1,threshold:.03}],{errors:s,pipeline:c,bestPosition:h}=await((e,t,a,n=null)=>{const i=[];let r=0;return new Promise((o=>{const s=setInterval((()=>{if(r==a.length)return clearInterval(s),void o({pipeline:i,bestPosition:p(i[i.length-1][0])});if(r>i.length)return;const{useEveryXPixel:c,useEveryXLayer:h,threshold:d}=a[r];if(0===r){const[o,s,l]=g(e,t,{useEveryXPixel:c,useEveryXLayer:h,threshold:d});return i.push([o,s,l]),null!=n&&n({layers:a.length,layerFinished:r+1}),void r++}if(null==i[r-1][0]||0===i[r-1][0].length)return clearInterval(s),void o({errors:["No match found"]});if(!i[r-1][0].some((e=>null!=e)))return clearInterval(s),void o({errors:["No match found"]});const l=[p(i[r-1][0])],[u,y,v]=m(e,t,l,i[r-1][1],{useEveryXPixel:c,useEveryXLayer:h,threshold:d});i.push([u,y,v]),null!=n&&n({layers:a.length,layerFinished:r+1}),r++}),0)}))})(e,t,a?o:r,n);return{errors:s,pipeline:c,bestPosition:h}},v=e=>e.data[0].imageWidth<=25?1:e.data[0].imageWidth<=75?5:10,f=e=>{document.querySelector("#progress-bar > div").style.width=`${Math.round(100*e)}%`},w=e=>{null!=e&&null!=e&&e.forEach((e=>(e=>{document.querySelector("#crop-info").innerHTML=`<span>${e}</span>`,f(1)})(e)))},x=async({imagePath:e=null,arrayBuffer:i=null})=>{if(null==e&&null==i)return{errors:["No image provided"]};if(null!=e){const t=(e=>{const t=[];return null!=e&&null!=e||t.push("No image path provided"),t})(e);if(0!=t.length)return{errors:t};i=await(async e=>{const t=await a.get(e,{responseType:"arraybuffer"});return n.Buffer.from(t.data,"utf-8")})(e)}let r;try{r=t(i)}catch(o){return{errors:["An image provided is not a tiff. Currently this tool only accepts tiffs."]}}return{data:r}},L=({errorHandler:e=w,callback:t})=>async a=>{const n=a.target.files[0],i=await n.arrayBuffer(),{data:r,errors:o}=await x({arrayBuffer:i,getImageDimensions:async()=>{const e=window.URL.createObjectURL(n);return await(e=>new Promise((t=>{const a=new Image;a.onload=()=>{t({imageHeight:a.height,imageWidth:a.width})},a.src=e})))(e)}});e(o),null!=r&&t({data:r,dimensions:{width:r[0].imageWidth,height:r[0].imageLength}})},E=(e,t,a,n)=>{let r=new i(t,a,e,{kind:"GREY"});return r=r.rotate(-n,{interpolation:"bilinear"}),r},S=(e,t)=>{const a=e.parent.width,n=Math.abs(a*Math.sin(X(t))),i=n/(Math.abs(a*Math.cos(X(t)))+n)*a,r=Math.trunc(i*Math.cos(X(t))),o=Math.trunc(n-i*Math.sin(X(t))),s=e.width-o-r,c=e.height-r-o;return e=e.crop({x:r,y:o,width:s,height:c})},X=e=>e*Math.PI/180,P=(e,t)=>(e.imageWidth=e.width,e.imageLength=e.height,Array.from({length:t},(t=>e))),b=(e,t,a,{strokeColor:n="rgb(64, 196, 82)",highlightColor:i="rgba(64, 196, 82, 0.3)"}={})=>{const r=e.getContext("2d");r.fillStyle=i,r.strokeStyle=n;const{x:o,y:s}=t,{w:c,h:h}=a;r.fillRect(o,s,c,h),r.strokeRect(o,s,c,h)},W=({imageData:e,width:t,height:a,canvasElement:n,imageRange:i=[0,255],colorScale:o="greys"})=>{const s=new r({canvas:n,data:e,width:t,height:a,domain:i,colorScale:o,useWebGL:!1});return s.render(),s};function M(e,t,a){return e+a*t}let I=!0;const z=()=>{document.querySelector("#guide-text-container").style.display="block"},R=()=>{document.querySelector("#guide-text-container").style.display="none"},C=()=>{document.querySelector("#toggle-guide-text").innerHTML="Show Usage Guide"},q=()=>{document.querySelector("#toggle-guide-text").innerHTML="Hide Usage Guide"},D={sourceImage:null,crop:null},$=L({callback:e=>{D.sourceImage=e,O()}}),k=L({callback:e=>{D.crop=e,O()}}),A=L({callback:e=>{if(null==D.crop||null==D.crop.position)return;if(D.crop.dimensions.width!=e.dimensions.width||D.crop.dimensions.height!=e.dimensions.height)return;const t=document.querySelector("#replaced-crop-canvas"),a=D.sourceImage.data[D.crop.position.z-1];(async({imageData:e,width:t,height:a,canvasElement:n,imageRange:i=[0,255],colorScale:o="greys",cropPosition:s,cropDimensions:c,angle:h=null,newCrop:d})=>{const l=n.getContext("2d"),{x:u,y:g}=s,{width:m,height:p}=c,y=new r({canvas:n,data:e,width:t,height:a,domain:i,colorScale:o,useWebGL:!1});y.render();const v=document.createElement("canvas");new r({canvas:v,data:d.data[0].data,width:d.dimensions.width,height:d.dimensions.height,domain:i,colorScale:o,useWebGL:!1}).render();const f=v.getContext("2d"),w=await createImageBitmap(f.getImageData(0,0,d.dimensions.width,d.dimensions.height));if(l.save(),l.translate(u+m/2,g+p/2),null!=h&&l.rotate(X(h)),l.drawImage(w,-m/2,-p/2),l.restore(),null!=h){l.save();const e=await createImageBitmap(l.getImageData(u,g,m,p));l.translate(u+m/2,g+p/2),l.drawImage(e,-m/2,-p/2),l.restore()}document.querySelector("#replaced-crop-canvas").style.visibility="visible"})({imageData:a.data,width:a.imageWidth,height:a.imageLength,canvasElement:t,cropPosition:D.crop.position,cropDimensions:D.crop.dimensions,angle:D.crop.isRotated?D.crop.angle:null,newCrop:e})}});document.querySelector("#new-crop-input").addEventListener("change",A),document.querySelector("#source-image-input").addEventListener("change",$),document.querySelector("#crop-image-input").addEventListener("change",k),document.querySelector("#toggle-guide-text").addEventListener("click",(()=>{if(I)return z(),q(),void(I=!1);R(),C(),I=!0}));const G=e=>{const t=D.crop.data[0],a=((e,t,a,n,i=1)=>{let r=E(e,t,a,n);return r=S(r,n),P(r,i)})(t.data,t.imageWidth,t.imageLength,e,D.crop.data.length);D.crop={data:a,dimensions:D.crop.dimensions,angle:e,isRotated:!0}},H=()=>{const e=((e,t,a,n,{width:r=150,height:o=150}={})=>{let s=new i(t,a,e,{kind:"GREY"});const c=Math.min(r,t),h=Math.min(o,a);return s=s.crop({x:0,y:0,width:c,height:h}),P(s,n)})(D.crop.data[0].data,D.crop.dimensions.width,D.crop.dimensions.height,D.crop.data.length,{width:150,height:150});D.crop={data:e,dimensions:D.crop.dimensions}},T=({position:e,sourceCanvas:t})=>{const a={width:D.crop.data[0].imageWidth,height:D.crop.data[0].imageLength},{position:n}=((e,t,a)=>({position:{x:e.x-Math.round((a.width-t.width)/2),y:e.y-Math.round((a.height-t.height)/2),z:e.z},width:a.width,height:a.height}))(e,a,D.crop.dimensions);D.crop.position=n,b(t,n,{w:D.crop.dimensions.width,h:D.crop.dimensions.height})},B=({layers:e,layerFinished:t})=>{f(t/e)},O=async()=>{if(null==D.sourceImage||null==D.crop)return;document.querySelector("#replaced-crop-canvas").style.visibility="hidden",document.querySelector("#info-area").style.visibility="visible",f(0);const e=document.querySelector("#source-image-canvas"),t=D.sourceImage.data[0];W({imageData:t.data,width:t.imageWidth,height:t.imageLength,canvasElement:e});const a=((e,t)=>{const a=[];return null!=e&&null!=e||a.push("The source image provided is not defined"),null!=t&&null!=t||a.push("The cropped image provided is not defined"),(e.data.length<t.data.length||e.dimensions.width<t.dimensions.width||e.dimensions.height<t.dimensions.height)&&a.push("The source image provided is smaller than the cropped image"),e.data.length==t.data.length&&e.dimensions.width==t.dimensions.width&&e.dimensions.height==t.dimensions.height&&a.push("The crop provided is the same size as the source image"),a})(D.sourceImage,D.crop);if(w(a),a.length>0)return;const{isRotated:n,angle:i}=(e=>{const{data:t,imageWidth:a,imageLength:n}=e.data[0],i=t[M(0,0,a)],r=t[M(a,0,a)],o=t[M(0,n-1,a)],s=t[M(a-1,n-1,a)];if(0!==i||0!==r||0!==o||0!==s)return{isRotated:!1};let c=a;for(let g=a-1;g>=0&&0===t[M(g-1,0,a)];g--)c=g;let h=0;for(let g=1;g<=n&&0===t[M(a-1,g,a)];g++)h=g;if(c===a&&0===h)return{isRotated:!1};const d=a-c,l=.5*d*h;let u=0;for(let g=c;g<a;g++)for(let e=0;e<h;e++)0===t[M(g,e,a)]&&u++;return u/l<.45?{isRotated:!1}:{isRotated:!0,angle:180*Math.atan(h/d)/Math.PI}})(D.crop);n?G(i):H();const{errors:r,bestPosition:o}=await y(D.sourceImage,D.crop,{isRotated:n,pipelineLayerCompleteCallback:B});if(w(r),null!=r&&r.length>0)return;const s={x:o.x,y:o.y,z:o.z+1};D.crop.position=s;const c=D.sourceImage.data[s.z-1];W({imageData:c.data,width:c.imageWidth,height:c.imageLength,canvasElement:e}),n?T({position:s,sourceCanvas:e}):(({position:e,sourceCanvas:t})=>{const{position:a}=((e,t)=>({position:{x:e.x,y:e.y,z:e.z},width:t.width,height:t.height}))(e,D.crop.dimensions);D.crop.position=a,b(t,a,{w:D.crop.dimensions.width,h:D.crop.dimensions.height})})({position:s,sourceCanvas:e}),j(),await U()},j=()=>{const e=`${D.crop.position.x}-${D.crop.position.x+D.crop.dimensions.width}`,t=`${D.crop.position.y}-${D.crop.position.y+D.crop.dimensions.height}`,a=`${D.crop.position.z}-${D.crop.position.z+D.crop.data.length}`,n=null!=D.crop.isRotated?`${Math.round(D.crop.angle)}`:"",i=`Crop Position: <br> x - ${e}, y - ${t}, z - ${a} ${null!=D.crop.isRotated?`<br> Rotated - ${n}°`:""}`;document.querySelector("#crop-info").innerHTML=i},U=()=>{const e=document.querySelector("#crop-canvas"),t=D.sourceImage.data[D.crop.position.z-1];(async({imageData:e,width:t,height:a,canvasElement:n,imageRange:i=[0,255],colorScale:o="greys",cropPosition:s,cropDimensions:c,angle:h=null})=>{const d=n.getContext("2d"),{x:l,y:u}=s,{width:g,height:m}=c,[p,y]=[t,a],v=new r({canvas:n,data:e,width:t,height:a,domain:i,colorScale:o,useWebGL:!1});v.render(),d.fillStyle="rgb(0,0,0)",d.save();const f=await createImageBitmap(d.getImageData(l,u,g,m));if(d.fillRect(0,0,p,y),d.translate(l+g/2,u+m/2),null!=h&&d.rotate(X(h)),d.drawImage(f,-g/2,-m/2),d.restore(),null!=h){d.save();const e=await createImageBitmap(d.getImageData(l,u,g,m));d.fillRect(0,0,p,y),d.translate(l+g/2,u+m/2),d.drawImage(e,-g/2,-m/2),d.restore()}})({imageData:t.data,width:t.imageWidth,height:t.imageLength,canvasElement:e,cropPosition:D.crop.position,cropDimensions:D.crop.dimensions,angle:D.crop.isRotated?D.crop.angle:null})};
