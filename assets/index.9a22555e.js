import{g as e,d as t,a as i,b as n,I as a,p as r,v as o}from"./vendor.ce0ff7dc.js";const s=new e.exports.GPU({mode:"gpu"});function c(e,t,i){return e+i*t}s.addFunction(c);const l=(e,t,i)=>{const n=Math.trunc(Math.abs(e.data[0].imageWidth-t.data[0].imageWidth)/i),a=Math.trunc(Math.abs(e.data[0].imageLength-t.data[0].imageLength)/i);return s.createKernel((function(e,t){const i=this.thread.x*this.constants.useEveryXPixel,n=this.thread.y*this.constants.useEveryXPixel;let a=0;for(let r=0;r<this.constants.cropLayerWidth;r+=this.constants.useEveryXPixel){const o=i+r;for(let r=0;r<this.constants.cropLayerLength;r+=this.constants.useEveryXPixel){const s=n+r,l=c(o,s,this.constants.sourceImageLayerWidth),d=c(o-i,s-n,this.constants.cropLayerWidth),h=e[l],u=t[d];a+=Math.abs(h-u)}}return a})).setOutput([n,a]).setConstants({sourceImageLayerWidth:e.data[0].imageWidth,cropLayerWidth:t.data[0].imageWidth,cropLayerLength:t.data[0].imageLength,useEveryXPixel:i})},d=(e,t,i,n,a,r,o)=>{const{xAxisScans:l,yAxisScans:d}=u(e,t,i,n);return s.createKernel((function(e,t){const i=this.thread.x*this.constants.useEveryXPixel+this.constants.originX,n=this.thread.y*this.constants.useEveryXPixel+this.constants.originY;let a=0;for(let r=0;r<this.constants.cropLayerWidth;r+=this.constants.useEveryXPixel){const o=i+r;for(let r=0;r<this.constants.cropLayerLength;r+=this.constants.useEveryXPixel){const s=n+r,l=c(o,s,this.constants.sourceImageLayerWidth),d=c(o-i,s-n,this.constants.cropLayerWidth),h=e[l],u=t[d];a+=Math.abs(h-u)}}return a})).setOutput([l,d]).setConstants({sourceImageLayerWidth:e.data[0].imageWidth,cropLayerWidth:t.data[0].imageWidth,cropLayerLength:t.data[0].imageLength,useEveryXPixel:a,originX:r,originY:o})},h=(e,t,i)=>Math.min(Math.max(e,t),i),u=(e,t,i,n)=>{const{useEveryXPixel:a,useEveryXLayer:r}=n(),o=Math.abs(e.data[0].imageWidth-t.data[0].imageWidth),s=h(i.x-a,0,o),c=h(i.x+a,0,o)-s,l=Math.abs(e.data[0].imageLength-t.data[0].imageLength),d=h(i.y-a,0,l),u=h(i.y+a,0,l)-d,g=Math.abs(e.data.length-t.data.length),m=h(i.z-r,0,g);return{xScanStart:s,xAxisScans:c,yScanStart:d,yAxisScans:u,zScanStart:m,zAxisScans:h(i.z+r,0,g)-m}},g=({result:e,crop:t,convertPosition:i,threshold:n=.1})=>{const{useEveryXPixel:a,useEveryXLayer:r}=i(),o=(({threshold:e=.1,cropWidth:t,cropHeight:i,range:n=[0,255],useEveryXPixel:a})=>e*Math.abs(n[0]-n[1])*Math.trunc(t/a*i/a))({threshold:n,cropWidth:t.data[0].imageWidth,cropHeight:t.data[0].imageLength,useEveryXPixel:a,useEveryXLayer:r}),s=[];for(const[c,l]of Object.entries(e))for(const[e,t]of Object.entries(l))for(const[i,n]of Object.entries(t))if(n<o){const t=[c,e,i].map((e=>parseInt(e)));s.push({difference:n,index:t})}if(0==s.length)return null;return s.map((e=>{const t=e.index;return Object.assign(i({x:t[2],y:t[1],z:t[0]}),{difference:e.difference})}))},m=(e,t,{useEveryXPixel:i,useEveryXLayer:n,threshold:a})=>{const[r,o]=((e,t,{useEveryXLayer:i,useEveryXPixel:n})=>{const a=l(e,t,n),r=Math.abs(e.data.length-t.data.length);let o=[];for(let s=0;s<=r;s+=i){const i=e.data[s],n=t.data[0];o.push(a(i.data,n.data))}return a.destroy(),[o,(e=null)=>null==e?{useEveryXPixel:n,useEveryXLayer:i}:{x:e.x*n,y:e.y*n,z:e.z*i}]})(e,t,{useEveryXPixel:i,useEveryXLayer:n});return[g({result:r,crop:t,convertPosition:o,threshold:a}),o,r]},p=(e,t,i,n,{useEveryXPixel:a,useEveryXLayer:r,threshold:o})=>{const[s,c]=((e,t,i,n,{useEveryXLayer:a,useEveryXPixel:r})=>{const o=i.map(((a,o)=>{const{xScanStart:s,yScanStart:c}=u(e,t,i[o],n);return d(e,t,a,n,r,s,c)})).map(((r,o)=>{const{zScanStart:s,zAxisScans:c}=u(e,t,i[o],n);let l=[];for(let i=s;i<=s+c;i+=a){const n=e.data[i],a=t.data[0];l.push(r(n.data,a.data))}return r.destroy(),l})),{zScanStart:s,xScanStart:c,yScanStart:l}=u(e,t,i[0],n);return[o,(e=null)=>null==e?{useEveryXPixel:r,useEveryXLayer:a}:{x:e.x*r+c,y:e.y*r+l,z:e.z*a+s}]})(e,t,i,n,{useEveryXPixel:a,useEveryXLayer:r});return[s.map((e=>g({result:e,crop:t,convertPosition:c,threshold:o}))).reduce(((e,t)=>e.concat(t)),[]),c,s]},y=e=>e.reduce(((e,t)=>null==t?e:t.difference<e.difference?t:e),{difference:Number.MAX_VALUE}),v=async(e,t,{isRotated:i=!1,pipelineLayerCompleteCallback:n=null}={})=>{const a=f(t),r=[{useEveryXPixel:a,useEveryXLayer:50,threshold:.1},{useEveryXPixel:a,useEveryXLayer:5,threshold:.06},{useEveryXPixel:1,useEveryXLayer:1,threshold:.01}],o=[{useEveryXPixel:a,useEveryXLayer:50,threshold:.1},{useEveryXPixel:a,useEveryXLayer:5,threshold:.08},{useEveryXPixel:1,useEveryXLayer:1,threshold:.03}],{errors:s,pipeline:c,bestPosition:l}=await((e,t,i,n=null)=>{const a=[];let r=0;return new Promise((o=>{const s=setInterval((()=>{if(r==i.length)return clearInterval(s),void o({pipeline:a,bestPosition:y(a[a.length-1][0])});if(r>a.length)return;const{useEveryXPixel:c,useEveryXLayer:l,threshold:d}=i[r];if(0===r){const[o,s,h]=m(e,t,{useEveryXPixel:c,useEveryXLayer:l,threshold:d});return a.push([o,s,h]),null!=n&&n({layers:i.length,layerFinished:r+1}),void r++}if(null==a[r-1][0]||0===a[r-1][0].length)return clearInterval(s),void o({errors:["No match found"]});if(!a[r-1][0].some((e=>null!=e)))return clearInterval(s),void o({errors:["No match found"]});const h=[y(a[r-1][0])],[u,g,v]=p(e,t,h,a[r-1][1],{useEveryXPixel:c,useEveryXLayer:l,threshold:d});a.push([u,g,v]),null!=n&&n({layers:i.length,layerFinished:r+1}),r++}),0)}))})(e,t,i?o:r,n);return{errors:s,pipeline:c,bestPosition:l}},f=e=>e.data[0].imageWidth<=25?1:e.data[0].imageWidth<=75?5:10,w=e=>{document.querySelector("#progress-bar > div").style.width=`${Math.round(100*e)}%`},x=e=>{null!=e&&null!=e&&e.forEach((e=>(e=>{document.querySelector("#crop-info").innerHTML=`<span>${e}</span>`,w(1)})(e)))},L=async({imagePath:e=null,arrayBuffer:a=null})=>{if(null==e&&null==a)return{errors:["No image provided"]};if(null!=e){const t=(e=>{const t=[];return null!=e&&null!=e||t.push("No image path provided"),t})(e);if(0!=t.length)return{errors:t};a=await(async e=>{const t=await i.get(e,{responseType:"arraybuffer"});return n.Buffer.from(t.data,"utf-8")})(e)}let r;try{r=t(a)}catch(o){return{errors:["An image provided is not a tiff. Currently this tool only accepts tiffs."]}}return{data:r}},E=({errorHandler:e=x,callback:t})=>async i=>{const n=i.target.files[0],a=await n.arrayBuffer(),{data:r,errors:o}=await L({arrayBuffer:a,getImageDimensions:async()=>{const e=window.URL.createObjectURL(n);return await(e=>new Promise((t=>{const i=new Image;i.onload=()=>{t({imageHeight:i.height,imageWidth:i.width})},i.src=e})))(e)}});e(o),null!=r&&t({data:r,original:r,dimensions:{width:r[0].imageWidth,height:r[0].imageLength},originalDimensions:{width:r[0].imageWidth,height:r[0].imageLength}})},S=(e,t,i,n)=>{let r=new a(t,i,e,{kind:"GREY"});return r=r.rotate(-n,{interpolation:"bilinear"}),r},X=(e,t)=>{const i=Math.max(e.parent.width,e.parent.height),n=Math.abs(i*Math.sin(b(t))),a=n/(Math.abs(i*Math.cos(b(t)))+n)*i,r=Math.trunc(a*Math.cos(b(t))),o=Math.trunc(n-a*Math.sin(b(t))),s=e.width-o-r,c=e.height-r-o;return e=e.crop({x:r,y:o,width:s,height:c})},b=e=>e*Math.PI/180,P=(e,t)=>(e.imageWidth=e.width,e.imageLength=e.height,Array.from({length:t},(t=>e))),R=(e,t,i=0)=>{const n=t.width,a=t.height,r=e.dimensions.width,o=[];for(let s=0;s<a;s++)for(let t=0;t<n;t++){const n=e.data[s].data[t+i*r];o.push(n)}return new Uint8Array(o)},W=(e,t,i=0)=>{const n=t.width,a=t.height,r=e.dimensions.width,o=[];for(let s=0;s<a;s++)for(let t=0;t<n;t++){const n=e.data[s].data[i+t*r];o.push(n)}return new Uint8Array(o)},I=(e,t)=>"left"==t?{width:e.dimensions.height,height:e.data.length,length:e.dimensions.width}:"top"==t?{width:e.dimensions.width,height:e.data.length,length:e.dimensions.height}:void 0,M=(e,t,i)=>new a(t,i,e,{kind:"GREY"}).rotateRight().flipX(),D=(e,t,i,{strokeColor:n="rgb(64, 196, 82)",highlightColor:a="rgba(64, 196, 82, 0.3)"}={})=>{const r=e.getContext("2d");r.fillStyle=a,r.strokeStyle=n;const{x:o,y:s}=t,{w:c,h:l}=i;r.fillRect(o,s,c,l),r.strokeRect(o,s,c,l)},z=({imageData:e,width:t,height:i,canvasElement:n,imageRange:a=[0,255],colorScale:o="greys"})=>{const s=new r({canvas:n,data:e,width:t,height:i,domain:a,colorScale:o,useWebGL:!1});return s.render(),s};function C(e,t,i){return e+i*t}const q=e=>{const{data:t,imageWidth:i,imageLength:n}=e.data[0],a=t[C(0,0,i)],r=t[C(i,0,i)],o=t[C(0,n-1,i)],s=t[C(i-1,n-1,i)];if(0!==a||0!==r||0!==o||0!==s)return{isRotated:!1};let c=i;for(let g=i-1;g>=0&&0===t[C(g-1,0,i)];g--)c=g;let l=0;for(let g=1;g<=n&&0===t[C(i-1,g,i)];g++)l=g;if(c===i&&0===l)return{isRotated:!1};const d=i-c,h=.5*d*l;let u=0;for(let g=c;g<i;g++)for(let e=0;e<l;e++)0===t[C(g,e,i)]&&u++;if(u/h<.45)return{isRotated:!1};return{isRotated:!0,angle:180*Math.atan(l/d)/Math.PI}};let k=!0;const $=()=>{document.querySelector("#guide-text-container").style.display="block"},A=()=>{document.querySelector("#guide-text-container").style.display="none"},G=()=>{document.querySelector("#toggle-guide-text").innerHTML="Show Usage Guide"},U=()=>{document.querySelector("#toggle-guide-text").innerHTML="Hide Usage Guide"};!function(e={}){const{immediate:t=!1,onNeedRefresh:i,onOfflineReady:n}=e;let a;"serviceWorker"in navigator&&(a=new o("./sw.js",{scope:"./"}),a.addEventListener("activated",(e=>{e.isUpdate?window.location.reload():null==n||n()})),a.register({immediate:t}).then((e=>e)))}({onOfflineReady(){console.log("Working in offline mode.")}});const H={sourceImage:null,crop:null},O=E({callback:e=>{H.sourceImage=e,_()}}),T=E({callback:e=>{H.crop=e,_()}}),B=E({callback:e=>{if(null==H.crop||null==H.crop.position)return;if(H.crop.dimensions.width!=e.dimensions.width||H.crop.dimensions.height!=e.dimensions.height)return void(document.querySelector("#warning-text").style.display="block");document.querySelector("#warning-text").style.display="none";const t=document.querySelector("#replaced-crop-canvas"),i=H.sourceImage.data[H.crop.position.z-1];(async({imageData:e,width:t,height:i,canvasElement:n,imageRange:a=[0,255],colorScale:o="greys",cropPosition:s,cropDimensions:c,angle:l=null,newCrop:d})=>{const h=n.getContext("2d"),{x:u,y:g}=s,{width:m,height:p}=c,y=new r({canvas:n,data:e,width:t,height:i,domain:a,colorScale:o,useWebGL:!1});y.render();const v=document.createElement("canvas");new r({canvas:v,data:d.data[0].data,width:d.dimensions.width,height:d.dimensions.height,domain:a,colorScale:o,useWebGL:!1}).render();const f=v.getContext("2d"),w=await createImageBitmap(f.getImageData(0,0,d.dimensions.width,d.dimensions.height));if(h.save(),h.translate(u+m/2,g+p/2),null!=l&&h.rotate(b(l)),h.drawImage(w,-m/2,-p/2),h.restore(),null!=l){h.save();const e=await createImageBitmap(h.getImageData(u,g,m,p));h.translate(u+m/2,g+p/2),h.drawImage(e,-m/2,-p/2),h.restore()}document.querySelector("#replaced-crop-canvas").style.visibility="visible"})({imageData:i.data,width:i.imageWidth,height:i.imageLength,canvasElement:t,cropPosition:H.crop.position,cropDimensions:H.crop.dimensions,angle:H.crop.isRotated?H.crop.angle:null,newCrop:e})}});document.querySelector("#new-crop-input").addEventListener("change",B),document.querySelector("#source-image-input").addEventListener("change",O),document.querySelector("#crop-image-input").addEventListener("change",T),document.querySelector("#toggle-guide-text").addEventListener("click",(()=>{if(k)return $(),U(),void(k=!1);A(),G(),k=!0}));const j=e=>{const t=H.crop.data[0],i=((e,t,i,n,a=1)=>{let r=S(e,t,i,n);return r=X(r,n),P(r,a)})(t.data,t.imageWidth,t.imageLength,e,H.crop.data.length);H.crop={data:i,original:H.crop.original,dimensions:H.crop.dimensions,originalDimensions:H.crop.originalDimensions,angle:e,isRotated:!0}},N=()=>{const e=((e,t,i,n,{width:r=150,height:o=150}={})=>{let s=new a(t,i,e,{kind:"GREY"});const c=Math.min(r,t),l=Math.min(o,i);return s=s.crop({x:0,y:0,width:c,height:l}),P(s,n)})(H.crop.data[0].data,H.crop.dimensions.width,H.crop.dimensions.height,H.crop.data.length,{width:150,height:150});H.crop={data:e,original:H.crop.original,dimensions:H.crop.dimensions,originalDimensions:H.crop.originalDimensions}},Y=({position:e,sourceCanvas:t})=>{const i={width:H.crop.data[0].imageWidth,height:H.crop.data[0].imageLength},{position:n}=((e,t,i)=>({position:{x:e.x-Math.round((i.width-t.width)/2),y:e.y-Math.round((i.height-t.height)/2),z:e.z},width:i.width,height:i.height}))(e,i,H.crop.dimensions);H.crop.position=n,D(t,n,{w:H.crop.dimensions.width,h:H.crop.dimensions.height})},F=({layers:e,layerFinished:t})=>{w(t/e)},K=(e,t=0)=>{H.crop=((e,t="left",i=0)=>{const n=I(e,t),a="top"==t?R(e,n,i):W(e,n,i);return{data:P(M(a,n.width,n.height),n.length),original:e.data,dimensions:n,originalDimensions:e.dimensions}})(H.crop,e,t)},V=async e=>{H.crop.data=H.crop.original,H.crop.dimensions=H.crop.originalDimensions,K(e);const t=q(H.crop);t.isRotated?j(t.angle):N();return{imageRotatedInfo:t,results:await v(H.sourceImage,H.crop,{isRotated:t.isRotated,isResliced:!0,pipelineLayerCompleteCallback:F}),reslicedDirection:e}},_=async()=>{if(null==H.sourceImage||null==H.crop)return;document.querySelector("#replaced-crop-canvas").style.visibility="hidden",document.querySelector("#info-area").style.visibility="visible",document.querySelector("#warning-text").style.display="none",w(0);const e=document.querySelector("#source-image-canvas"),t=H.sourceImage.data[0];z({imageData:t.data,width:t.imageWidth,height:t.imageLength,canvasElement:e});const i=((e,t)=>{const i=[];return null!=e&&null!=e||i.push("The source image provided is not defined"),null!=t&&null!=t||i.push("The cropped image provided is not defined"),(e.data.length<t.data.length||e.dimensions.width<t.dimensions.width||e.dimensions.height<t.dimensions.height)&&i.push("The source image provided is smaller than the cropped image"),e.data.length==t.data.length&&e.dimensions.width==t.dimensions.width&&e.dimensions.height==t.dimensions.height&&i.push("The crop provided is the same size as the source image"),i})(H.sourceImage,H.crop);if(x(i),i.length>0)return;const{errors:n,bestPosition:a,isRotated:r,reslicedDirection:o}=await(async()=>{let e=null,t=q(H.crop);t.isRotated?j(t.angle):N();let i=await v(H.sourceImage,H.crop,{isRotated:t.isRotated,pipelineLayerCompleteCallback:F});if(null!=i.errors&&i.errors.length>0){const n=await V("top");t=n.imageRotatedInfo,i=n.results,e=n.reslicedDirection}if(null!=i.errors&&i.errors.length>0){const n=await V("left");t=n.imageRotatedInfo,i=n.results,e=n.reslicedDirection}return{errors:i.errors,bestPosition:i.bestPosition,isRotated:t.isRotated,reslicedDirection:e}})();if(x(n),null!=n&&n.length>0)return;const s={x:a.x,y:a.y,z:a.z+1};H.crop.position=s,H.crop.reslicedDirection=o;const c=H.sourceImage.data[s.z-1];z({imageData:c.data,width:c.imageWidth,height:c.imageLength,canvasElement:e}),r?Y({position:s,sourceCanvas:e}):(({position:e,sourceCanvas:t})=>{const{position:i}=((e,t)=>({position:{x:e.x,y:e.y,z:e.z},width:t.width,height:t.height}))(e,H.crop.dimensions);H.crop.position=i,D(t,i,{w:H.crop.dimensions.width,h:H.crop.dimensions.height})})({position:s,sourceCanvas:e}),J(),await Z()},J=()=>{const e=`${H.crop.position.x}-${H.crop.position.x+H.crop.dimensions.width}`,t=`${H.crop.position.y}-${H.crop.position.y+H.crop.dimensions.height}`,i=`${H.crop.position.z}-${H.crop.position.z+H.crop.data.length}`,n=null!=H.crop.isRotated?`${Math.round(H.crop.angle)}`:"",a=null!=H.crop.reslicedDirection?`Resliced from: ${Q(H.crop.reslicedDirection)}`:"",r=`Crop Position: <br> x - ${e}, y - ${t}, z - ${i} ${null!=H.crop.isRotated?`<br> Rotated - ${n}°`:""} ${null!=H.crop.reslicedDirection?`<br> ${a}`:""}`;document.querySelector("#crop-info").innerHTML=r},Q=e=>e[0].toUpperCase()+e.slice(1),Z=()=>{const e=document.querySelector("#crop-canvas"),t=H.sourceImage.data[H.crop.position.z-1];(async({imageData:e,width:t,height:i,canvasElement:n,imageRange:a=[0,255],colorScale:o="greys",cropPosition:s,cropDimensions:c,angle:l=null})=>{const d=n.getContext("2d"),{x:h,y:u}=s,{width:g,height:m}=c,[p,y]=[t,i],v=new r({canvas:n,data:e,width:t,height:i,domain:a,colorScale:o,useWebGL:!1});v.render(),d.fillStyle="rgb(0,0,0)",d.save();const f=await createImageBitmap(d.getImageData(h,u,g,m));if(d.fillRect(0,0,p,y),d.translate(h+g/2,u+m/2),null!=l&&d.rotate(b(l)),d.drawImage(f,-g/2,-m/2),d.restore(),null!=l){d.save();const e=await createImageBitmap(d.getImageData(h,u,g,m));d.fillRect(0,0,p,y),d.translate(h+g/2,u+m/2),d.drawImage(e,-g/2,-m/2),d.restore()}})({imageData:t.data,width:t.imageWidth,height:t.imageLength,canvasElement:e,cropPosition:H.crop.position,cropDimensions:H.crop.dimensions,angle:H.crop.isRotated?H.crop.angle:null})};
