import{g as e,d as t,a,b as r,I as n,p as i}from"./vendor.a78a7e74.js";const s=new e.exports.GPU({mode:"gpu"});function o(e,t,a){return e+a*t}s.addFunction(o);const c=(e,t,a)=>{const r=Math.trunc(Math.abs(e.data[0].imageWidth-t.data[0].imageWidth)/a),n=Math.trunc(Math.abs(e.data[0].imageLength-t.data[0].imageLength)/a);return s.createKernel((function(e,t){const a=this.thread.x*this.constants.useEveryXPixel,r=this.thread.y*this.constants.useEveryXPixel;let n=0;for(let i=0;i<this.constants.cropLayerWidth;i+=this.constants.useEveryXPixel){const s=a+i;for(let i=0;i<this.constants.cropLayerLength;i+=this.constants.useEveryXPixel){const c=r+i,h=o(s,c,this.constants.sourceImageLayerWidth),l=o(s-a,c-r,this.constants.cropLayerWidth),d=e[h],u=t[l];n+=Math.abs(d-u)}}return n})).setOutput([r,n]).setConstants({sourceImageLayerWidth:e.data[0].imageWidth,cropLayerWidth:t.data[0].imageWidth,cropLayerLength:t.data[0].imageLength,useEveryXPixel:a})},h=(e,t,a,r,n,i,c)=>{const{xAxisScans:h,yAxisScans:l}=d(e,t,a,r);return s.createKernel((function(e,t){const a=this.thread.x*this.constants.useEveryXPixel+this.constants.originX,r=this.thread.y*this.constants.useEveryXPixel+this.constants.originY;let n=0;for(let i=0;i<this.constants.cropLayerWidth;i+=this.constants.useEveryXPixel){const s=a+i;for(let i=0;i<this.constants.cropLayerLength;i+=this.constants.useEveryXPixel){const c=r+i,h=o(s,c,this.constants.sourceImageLayerWidth),l=o(s-a,c-r,this.constants.cropLayerWidth),d=e[h],u=t[l];n+=Math.abs(d-u)}}return n})).setOutput([h,l]).setConstants({sourceImageLayerWidth:e.data[0].imageWidth,cropLayerWidth:t.data[0].imageWidth,cropLayerLength:t.data[0].imageLength,useEveryXPixel:n,originX:i,originY:c})},l=(e,t,a)=>Math.min(Math.max(e,t),a),d=(e,t,a,r)=>{const{useEveryXPixel:n,useEveryXLayer:i}=r(),s=Math.abs(e.data[0].imageWidth-t.data[0].imageWidth),o=l(a.x-n,0,s),c=l(a.x+n,0,s)-o,h=Math.abs(e.data[0].imageLength-t.data[0].imageLength),d=l(a.y-n,0,h),u=l(a.y+n,0,h)-d,g=Math.abs(e.data.length-t.data.length),y=l(a.z-i,0,g);return{xScanStart:o,xAxisScans:c,yScanStart:d,yAxisScans:u,zScanStart:y,zAxisScans:l(a.z+i,0,g)-y}},u=({result:e,crop:t,convertPosition:a,threshold:r=.1})=>{const{useEveryXPixel:n,useEveryXLayer:i}=a(),s=(({threshold:e=.1,cropWidth:t,cropHeight:a,range:r=[0,255],useEveryXPixel:n})=>e*Math.abs(r[0]-r[1])*Math.trunc(t/n*a/n))({threshold:r,cropWidth:t.data[0].imageWidth,cropHeight:t.data[0].imageLength,useEveryXPixel:n,useEveryXLayer:i}),o=[];for(const[c,h]of Object.entries(e))for(const[e,t]of Object.entries(h))for(const[a,r]of Object.entries(t))if(r<s){const t=[c,e,a].map((e=>parseInt(e)));o.push({difference:r,index:t})}if(0==o.length)return null;return o.map((e=>{const t=e.index;return Object.assign(a({x:t[2],y:t[1],z:t[0]}),{difference:e.difference})}))},g=(e,t,{useEveryXPixel:a,useEveryXLayer:r,threshold:n})=>{const[i,s]=((e,t,{useEveryXLayer:a,useEveryXPixel:r})=>{const n=c(e,t,r),i=Math.abs(e.data.length-t.data.length);let s=[];for(let o=0;o<=i;o+=a){const a=e.data[o],r=t.data[0];s.push(n(a.data,r.data))}return n.destroy(),[s,(e=null)=>null==e?{useEveryXPixel:r,useEveryXLayer:a}:{x:e.x*r,y:e.y*r,z:e.z*a}]})(e,t,{useEveryXPixel:a,useEveryXLayer:r});return[u({result:i,crop:t,convertPosition:s,threshold:n}),s,i]},y=(e,t,a,r,{useEveryXPixel:n,useEveryXLayer:i,threshold:s})=>{const[o,c]=((e,t,a,r,{useEveryXLayer:n,useEveryXPixel:i})=>{const s=a.map(((n,s)=>{const{xScanStart:o,yScanStart:c}=d(e,t,a[s],r);return h(e,t,n,r,i,o,c)})).map(((i,s)=>{const{zScanStart:o,zAxisScans:c}=d(e,t,a[s],r);let h=[];for(let a=o;a<=o+c;a+=n){const r=e.data[a],n=t.data[0];h.push(i(r.data,n.data))}return i.destroy(),h})),{zScanStart:o,xScanStart:c,yScanStart:l}=d(e,t,a[0],r);return[s,(e=null)=>null==e?{useEveryXPixel:i,useEveryXLayer:n}:{x:e.x*i+c,y:e.y*i+l,z:e.z*n+o}]})(e,t,a,r,{useEveryXPixel:n,useEveryXLayer:i});return[o.map((e=>u({result:e,crop:t,convertPosition:c,threshold:s}))).reduce(((e,t)=>e.concat(t)),[]),c,o]},p=e=>e.reduce(((e,t)=>null==t?e:t.difference<e.difference?t:e),{difference:Number.MAX_VALUE}),m=async(e,t,{isRotated:a=!1,pipelineLayerCompleteCallback:r=null}={})=>{const{errors:n,pipeline:i,bestPosition:s}=await((e,t,a,r=null)=>{const n=[];let i=0;return new Promise((s=>{const o=setInterval((()=>{if(i==a.length)return clearInterval(o),void s({pipeline:n,bestPosition:p(n[n.length-1][0])});if(i>n.length)return;const{useEveryXPixel:c,useEveryXLayer:h,threshold:l}=a[i];if(0===i){const[s,o,d]=g(e,t,{useEveryXPixel:c,useEveryXLayer:h,threshold:l});return n.push([s,o,d]),null!=r&&r({layers:a.length,layerFinished:i+1}),void i++}if(null==n[i-1][0]||0===n[i-1][0].length)return clearInterval(o),void s({errors:["No match found"]});if(!n[i-1][0].some((e=>null!=e)))return clearInterval(o),void s({errors:["No match found"]});const d=[p(n[i-1][0])],[u,m,v]=y(e,t,d,n[i-1][1],{useEveryXPixel:c,useEveryXLayer:h,threshold:l});n.push([u,m,v]),null!=r&&r({layers:a.length,layerFinished:i+1}),i++}),0)}))})(e,t,a?[{useEveryXPixel:5,useEveryXLayer:50,threshold:.1},{useEveryXPixel:1,useEveryXLayer:1,threshold:.03}]:[{useEveryXPixel:10,useEveryXLayer:50,threshold:.1},{useEveryXPixel:10,useEveryXLayer:5,threshold:.06},{useEveryXPixel:1,useEveryXLayer:1,threshold:.01}],r);return{errors:n,pipeline:i,bestPosition:s}},v=e=>{document.querySelector("#progress-bar > div").style.width=`${Math.round(100*e)}%`},f=e=>{null!=e&&null!=e&&e.forEach((e=>(e=>{document.querySelector("#crop-info").innerHTML=`<span>${e}</span>`,v(1)})(e)))},x=async({imagePath:e=null,arrayBuffer:n=null})=>{if(null==e&&null==n)return{errors:["No image provided"]};if(null!=e){const t=(e=>{const t=[];return null!=e&&null!=e||t.push("No image path provided"),t})(e);if(0!=t.length)return{errors:t};n=await(async e=>{const t=await a.get(e,{responseType:"arraybuffer"});return r.Buffer.from(t.data,"utf-8")})(e)}let i;try{i=t(n)}catch(s){return{errors:["An image provided is not a tiff. Currently this tool only accepts tiffs."]}}return{data:i}},L=({errorHandler:e=f,callback:t})=>async a=>{const r=a.target.files[0],n=await r.arrayBuffer(),{data:i,errors:s}=await x({arrayBuffer:n,getImageDimensions:async()=>{const e=window.URL.createObjectURL(r);return await(e=>new Promise((t=>{const a=new Image;a.onload=()=>{t({imageHeight:a.height,imageWidth:a.width})},a.src=e})))(e)}});e(s),null!=i&&t({data:i,dimensions:{width:i[0].imageWidth,height:i[0].imageLength}})},E=(e,t,a,r)=>{let i=new n(t,a,e,{kind:"GREY"});return i=i.rotate(-r,{interpolation:"bilinear"}),i},w=(e,t)=>{const a=e.parent.width,r=Math.abs(a*Math.sin(X(t))),n=r/(Math.abs(a*Math.cos(X(t)))+r)*a,i=Math.trunc(n*Math.cos(X(t))),s=Math.trunc(r-n*Math.sin(X(t))),o=e.width-s-i,c=e.height-i-s;return e=e.crop({x:i,y:s,width:o,height:c})},X=e=>e*Math.PI/180,P=(e,t)=>(e.imageWidth=e.width,e.imageLength=e.height,Array.from({length:t},(t=>e))),S=(e,t,a,{strokeColor:r="rgb(64, 196, 82)",highlightColor:n="rgba(64, 196, 82, 0.3)"}={})=>{const i=e.getContext("2d");i.fillStyle=n,i.strokeStyle=r;const{x:s,y:o}=t,{w:c,h:h}=a;i.fillRect(s,o,c,h),i.strokeRect(s,o,c,h)},b=({imageData:e,width:t,height:a,canvasElement:r,imageRange:n=[0,255],colorScale:s="greys"})=>{const o=new i({canvas:r,data:e,width:t,height:a,domain:n,colorScale:s,useWebGL:!1});return o.render(),o};function M(e,t,a){return e+a*t}let W=!0;const I=()=>{document.querySelector("#guide-text-container").style.display="block"},z=()=>{document.querySelector("#guide-text-container").style.display="none"},R=()=>{document.querySelector("#toggle-guide-text").innerHTML="Show Usage Guide"},C=()=>{document.querySelector("#toggle-guide-text").innerHTML="Hide Usage Guide"},$={sourceImage:null,crop:null},q=L({callback:e=>{$.sourceImage=e,G()}}),k=L({callback:e=>{$.crop=e,G()}});document.querySelector("#source-image-input").addEventListener("change",q),document.querySelector("#crop-image-input").addEventListener("change",k),document.querySelector("#toggle-guide-text").addEventListener("click",(()=>{if(W)return I(),C(),void(W=!1);z(),R(),W=!0}));const A=e=>{const t=$.crop.data[0],a=((e,t,a,r,n=1)=>{let i=E(e,t,a,r);return i=w(i,r),P(i,n)})(t.data,t.imageWidth,t.imageLength,e,$.crop.data.length);$.crop={data:a,dimensions:$.crop.dimensions,angle:e,isRotated:!0}},D=()=>{const e=((e,t,a,r,{width:i=150,height:s=150}={})=>{let o=new n(t,a,e,{kind:"GREY"});const c=Math.min(i,t),h=Math.min(s,a);return o=o.crop({x:0,y:0,width:c,height:h}),P(o,r)})($.crop.data[0].data,$.crop.dimensions.width,$.crop.dimensions.height,$.crop.data.length,{width:150,height:150});$.crop={data:e,dimensions:$.crop.dimensions}},H=({position:e,sourceCanvas:t})=>{const a={width:$.crop.data[0].imageWidth,height:$.crop.data[0].imageLength},{position:r}=((e,t,a)=>({position:{x:e.x-Math.round((a.width-t.width)/2),y:e.y-Math.round((a.height-t.height)/2),z:e.z},width:a.width,height:a.height}))(e,a,$.crop.dimensions);$.crop.position=r,S(t,r,{w:$.crop.dimensions.width,h:$.crop.dimensions.height})},T=({layers:e,layerFinished:t})=>{v(t/e)},G=async()=>{if(null==$.sourceImage||null==$.crop)return;document.querySelector("#info-area").style.visibility="visible",v(0);const e=document.querySelector("#source-image-canvas"),t=$.sourceImage.data[0];b({imageData:t.data,width:t.imageWidth,height:t.imageLength,canvasElement:e});const a=((e,t)=>{const a=[];return null!=e&&null!=e||a.push("The source image provided is not defined"),null!=t&&null!=t||a.push("The cropped image provided is not defined"),(e.data.length<t.data.length||e.dimensions.width<t.dimensions.width||e.dimensions.height<t.dimensions.height)&&a.push("The source image provided is smaller than the cropped image"),e.data.length==t.data.length&&e.dimensions.width==t.dimensions.width&&e.dimensions.height==t.dimensions.height&&a.push("The crop provided is the same size as the source image"),a})($.sourceImage,$.crop);if(f(a),a.length>0)return;const{isRotated:r,angle:n}=(e=>{const{data:t,imageWidth:a,imageLength:r}=e.data[0],n=t[M(0,0,a)],i=t[M(a,0,a)],s=t[M(0,r-1,a)],o=t[M(a-1,r-1,a)];if(0!==n||0!==i||0!==s||0!==o)return{isRotated:!1};let c=a;for(let g=a-1;g>=0&&0===t[M(g-1,0,a)];g--)c=g;let h=0;for(let g=1;g<=r&&0===t[M(a-1,g,a)];g++)h=g;if(c===a&&0===h)return{isRotated:!1};const l=a-c,d=.5*l*h;let u=0;for(let g=c;g<a;g++)for(let e=0;e<h;e++)0===t[M(g,e,a)]&&u++;return u/d<.45?{isRotated:!1}:{isRotated:!0,angle:180*Math.atan(h/l)/Math.PI}})($.crop);r?A(n):D();const{errors:i,bestPosition:s}=await m($.sourceImage,$.crop,{isRotated:r,pipelineLayerCompleteCallback:T});if(f(i),null!=i&&i.length>0)return;const o={x:s.x,y:s.y,z:s.z+1};$.crop.position=o;const c=$.sourceImage.data[o.z-1];b({imageData:c.data,width:c.imageWidth,height:c.imageLength,canvasElement:e}),r?H({position:o,sourceCanvas:e}):(({position:e,sourceCanvas:t})=>{const{position:a}=((e,t)=>({position:{x:e.x,y:e.y,z:e.z},width:t.width,height:t.height}))(e,$.crop.dimensions);$.crop.position=a,S(t,a,{w:$.crop.dimensions.width,h:$.crop.dimensions.height})})({position:o,sourceCanvas:e}),O(),await j()},O=()=>{const e=`${$.crop.position.x}-${$.crop.position.x+$.crop.dimensions.width}`,t=`${$.crop.position.y}-${$.crop.position.y+$.crop.dimensions.height}`,a=`${$.crop.position.z}-${$.crop.position.z+$.crop.data.length}`,r=null!=$.crop.isRotated?`${Math.round($.crop.angle)}`:"",n=`Crop Position: <br> x - ${e}, y - ${t}, z - ${a} ${null!=$.crop.isRotated?`<br> Rotated - ${r}°`:""}`;document.querySelector("#crop-info").innerHTML=n},j=()=>{const e=document.querySelector("#crop-canvas"),t=$.sourceImage.data[$.crop.position.z-1];(async({imageData:e,width:t,height:a,canvasElement:r,imageRange:n=[0,255],colorScale:s="greys",cropPosition:o,cropDimensions:c,angle:h=null})=>{const l=r.getContext("2d"),{x:d,y:u}=o,{width:g,height:y}=c,[p,m]=[t,a],v=new i({canvas:r,data:e,width:t,height:a,domain:n,colorScale:s,useWebGL:!1});v.render(),l.fillStyle="rgb(0,0,0)",l.save();const f=await createImageBitmap(l.getImageData(d,u,g,y));if(l.fillRect(0,0,p,m),l.translate(d+g/2,u+y/2),null!=h&&l.rotate(X(h)),l.drawImage(f,-g/2,-y/2),l.restore(),null!=h){l.save();const e=await createImageBitmap(l.getImageData(d,u,g,y));l.fillRect(0,0,p,m),l.translate(d+g/2,u+y/2),l.drawImage(e,-g/2,-y/2),l.restore()}})({imageData:t.data,width:t.imageWidth,height:t.imageLength,canvasElement:e,cropPosition:$.crop.position,cropDimensions:$.crop.dimensions,angle:$.crop.isRotated?$.crop.angle:null})};
