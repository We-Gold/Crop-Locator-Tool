import{I as e,p as t,g as i,d as n,a as r,b as o,v as a}from"./vendor.9c131f9f.js";let s=!0;const l=()=>{if(s)return c(),g(),void(s=!1);d(),h(),s=!0},c=()=>{document.querySelector("#guide-text-container").style.display="block"},d=()=>{document.querySelector("#guide-text-container").style.display="none"},h=()=>{document.querySelector("#toggle-guide-text").innerHTML="Show Usage Guide"},g=()=>{document.querySelector("#toggle-guide-text").innerHTML="Hide Usage Guide"},u={sourceImage:null,crop:null,mainCrop:null},p=e=>{document.querySelector("#progress-bar > div").style.width=`${Math.round(100*e)}%`},m=({layers:e,layerFinished:t})=>{p(t/e)},y=e=>{null!=e&&null!=e&&e.forEach((e=>(e=>{document.querySelector("#crop-info").innerHTML=`<span>${e}</span>`,p(1)})(e)))},f=(e,t)=>(e.imageWidth=e.width,e.imageLength=e.height,Array.from({length:t},(t=>e))),w=(t,i,n,r)=>{let o=new e(i,n,t,{kind:"GREY"});return o=o.rotate(-r,{interpolation:"bilinear"}),o},v=(e,t)=>{const i=Math.max(e.parent.width,e.parent.height),n=Math.abs(i*Math.sin(x(t))),r=n/(Math.abs(i*Math.cos(x(t)))+n)*i,o=Math.trunc(r*Math.cos(x(t))),a=Math.trunc(n-r*Math.sin(x(t))),s=e.width-a-o,l=e.height-o-a;return e=e.crop({x:o,y:a,width:s,height:l})},x=e=>e*Math.PI/180,L=function(){let e=0;const t=[{strokeColor:"rgb(64, 196, 82)",highlightColor:"rgb(64, 196, 82, 0.3)"},{strokeColor:"rgb(255, 243, 33)",highlightColor:"rgb(255, 243, 33, 0.3)"},{strokeColor:"rgb(193, 63, 63)",highlightColor:"rgb(193, 63, 63, 0.3)"}];return{getNextColor:(i=!1)=>(e=i?(e+1)%t.length:0,t[e])}}(),E=(e,t,i,{isNested:n=!1}={})=>{const r=e.getContext("2d"),{highlightColor:o,strokeColor:a}=L.getNextColor(n);r.fillStyle=o,r.strokeStyle=a;const{x:s,y:l}=t,{w:c,h:d}=i;r.fillRect(s,l,c,d),r.strokeRect(s,l,c,d)},b=({imageData:e,width:i,height:n,canvasElement:r,imageRange:o=[0,255],colorScale:a="greys"})=>{const s=new t({canvas:r,data:e,width:i,height:n,domain:o,colorScale:a,useWebGL:!1});return s.render(),s},S=document.querySelector("#source-image-canvas"),C=({position:e,isNested:t=!1})=>{const i={width:u.crop.data[0].imageWidth,height:u.crop.data[0].imageLength},{position:n}=((e,t,i)=>({position:{x:e.x-Math.round((i.width-t.width)/2),y:e.y-Math.round((i.height-t.height)/2),z:e.z},width:i.width,height:i.height}))(e,i,u.crop.dimensions);u.crop.position=n,E(S,n,{w:u.crop.dimensions.width,h:u.crop.dimensions.height},{isNested:t})},X=({position:e,isNested:t=!1})=>{const{position:i}=((e,t)=>({position:{x:e.x,y:e.y,z:e.z},width:t.width,height:t.height}))(e,u.crop.dimensions);u.crop.position=i,E(S,i,{w:u.crop.dimensions.width,h:u.crop.dimensions.height},{isNested:t})},P=()=>{const e=document.querySelector("#crop-canvas"),i=u.sourceImage.data[u.crop.position.z-1];(async({imageData:e,width:i,height:n,canvasElement:r,imageRange:o=[0,255],colorScale:a="greys",cropPosition:s,cropDimensions:l,angle:c=null})=>{const d=r.getContext("2d"),{x:h,y:g}=s,{width:u,height:p}=l,[m,y]=[i,n],f=new t({canvas:r,data:e,width:i,height:n,domain:o,colorScale:a,useWebGL:!1});f.render(),d.fillStyle="rgb(0,0,0)",d.save();const w=await createImageBitmap(d.getImageData(h,g,u,p));if(d.fillRect(0,0,m,y),d.translate(h+u/2,g+p/2),null!=c&&d.rotate(x(c)),d.drawImage(w,-u/2,-p/2),d.restore(),null!=c){d.save();const e=await createImageBitmap(d.getImageData(h,g,u,p));d.fillRect(0,0,m,y),d.translate(h+u/2,g+p/2),d.drawImage(e,-u/2,-p/2),d.restore()}})({imageData:i.data,width:i.imageWidth,height:i.imageLength,canvasElement:e,cropPosition:u.crop.position,cropDimensions:u.crop.dimensions,angle:u.crop.isRotated?u.crop.angle:null})},I=e=>{const t=Math.min(e.data[0].imageWidth,e.data[0].imageLength);return t<=50?1:t<100?4:10},M=(e,t,i,n)=>{const{useEveryXPixel:r,useEveryXLayer:o}=n(),a=Math.abs(e.data[0].imageWidth-t.data[0].imageWidth),s=W(i.x-r,0,a),l=W(i.x+r,0,a)-s,c=Math.abs(e.data[0].imageLength-t.data[0].imageLength),d=W(i.y-r,0,c),h=W(i.y+r,0,c)-d,g=Math.abs(e.data.length-t.data.length),u=W(i.z-o,0,g);return{xScanStart:s,xAxisScans:l,yScanStart:d,yAxisScans:h,zScanStart:u,zAxisScans:W(i.z+o,0,g)-u}},W=(e,t,i)=>Math.min(Math.max(e,t),i),R=new i.exports.GPU({mode:"gpu"});function D(e,t,i){return e+i*t}R.addFunction(D);const k=(e,t,i)=>{const n=Math.trunc(Math.abs(e.data[0].imageWidth-t.data[0].imageWidth)/i),r=Math.trunc(Math.abs(e.data[0].imageLength-t.data[0].imageLength)/i);return R.createKernel((function(e,t){const i=this.thread.x*this.constants.useEveryXPixel+this.constants.originX,n=this.thread.y*this.constants.useEveryXPixel+this.constants.originY;let r=0;for(let o=0;o<this.constants.cropLayerWidth;o+=this.constants.useEveryXPixel){const a=i+o;for(let o=0;o<this.constants.cropLayerLength;o+=this.constants.useEveryXPixel){const s=n+o,l=D(a,s,this.constants.sourceImageLayerWidth),c=D(a-i,s-n,this.constants.cropLayerWidth),d=e[l],h=t[c];r+=Math.abs(d-h)}}return r})).setOutput([n,r]).setConstants({sourceImageLayerWidth:e.data[0].imageWidth,cropLayerWidth:t.data[0].imageWidth,cropLayerLength:t.data[0].imageLength,useEveryXPixel:i,originX:0,originY:0})},z=(e,t,i,n,r,o,a)=>{const{xAxisScans:s,yAxisScans:l}=M(e,t,i,n);return R.createKernel((function(e,t){const i=this.thread.x*this.constants.useEveryXPixel+this.constants.originX,n=this.thread.y*this.constants.useEveryXPixel+this.constants.originY;let r=0;for(let o=0;o<this.constants.cropLayerWidth;o+=this.constants.useEveryXPixel){const a=i+o;for(let o=0;o<this.constants.cropLayerLength;o+=this.constants.useEveryXPixel){const s=n+o,l=D(a,s,this.constants.sourceImageLayerWidth),c=D(a-i,s-n,this.constants.cropLayerWidth),d=e[l],h=t[c];r+=Math.abs(d-h)}}return r})).setOutput([s,l]).setConstants({sourceImageLayerWidth:e.data[0].imageWidth,cropLayerWidth:t.data[0].imageWidth,cropLayerLength:t.data[0].imageLength,useEveryXPixel:r,originX:o,originY:a})},q=({result:e,crop:t,convertPosition:i,threshold:n=.1})=>{const{useEveryXPixel:r,useEveryXLayer:o}=i(),a=(({threshold:e=.1,cropWidth:t,cropHeight:i,range:n=[0,255],useEveryXPixel:r})=>e*Math.abs(n[0]-n[1])*Math.trunc(t/r*i/r))({threshold:n,cropWidth:t.data[0].imageWidth,cropHeight:t.data[0].imageLength,useEveryXPixel:r,useEveryXLayer:o}),s=[];for(const[l,c]of Object.entries(e))for(const[e,t]of Object.entries(c))for(const[i,n]of Object.entries(t))if(n<a){const t=[l,e,i].map((e=>parseInt(e)));s.push({difference:n,index:t})}if(0==s.length)return null;return s.map((e=>{const t=e.index;return Object.assign(i({x:t[2],y:t[1],z:t[0]}),{difference:e.difference})}))},$=(e,t,{useEveryXPixel:i,useEveryXLayer:n,threshold:r})=>{const[o,a]=((e,t,{useEveryXLayer:i,useEveryXPixel:n})=>{const r=k(e,t,n),o=Math.abs(e.data.length-t.data.length);let a=[];for(let s=0;s<=o;s+=i){const i=e.data[s],n=t.data[0];a.push(r(i.data,n.data))}return r.destroy(),[a,(e=null)=>null==e?{useEveryXPixel:n,useEveryXLayer:i}:{x:e.x*n,y:e.y*n,z:e.z*i}]})(e,t,{useEveryXPixel:i,useEveryXLayer:n});return[q({result:o,crop:t,convertPosition:a,threshold:r}),a,o]},A=(e,t,i,n,{useEveryXPixel:r,useEveryXLayer:o,threshold:a})=>{const[s,l]=((e,t,i,n,{useEveryXLayer:r,useEveryXPixel:o})=>{const a=i.map(((r,a)=>{const{xScanStart:s,yScanStart:l}=M(e,t,i[a],n);return z(e,t,r,n,o,s,l)})).map(((o,a)=>{const{zScanStart:s,zAxisScans:l}=M(e,t,i[a],n);let c=[];for(let i=s;i<=s+l;i+=r){const n=e.data[i],r=t.data[0];c.push(o(n.data,r.data))}return o.destroy(),c})),{zScanStart:s,xScanStart:l,yScanStart:c}=M(e,t,i[0],n);return[a,(e=null)=>null==e?{useEveryXPixel:o,useEveryXLayer:r}:{x:e.x*o+l,y:e.y*o+c,z:e.z*r+s}]})(e,t,i,n,{useEveryXPixel:r,useEveryXLayer:o});return[s.map((e=>q({result:e,crop:t,convertPosition:l,threshold:a}))).reduce(((e,t)=>e.concat(t)),[]),l,s]},H=e=>e.reduce(((e,t)=>null==t?e:t.difference<e.difference?t:e),{difference:Number.MAX_VALUE}),N=(e,t,i,n=null)=>{const r=[];let o=null,a=0;const s=()=>{a++};return new Promise((l=>{const c=setInterval((()=>{a==i.length&&(clearInterval(c),null==r[r.length-1][0][0]&&(o=["No match found"]),l(null==o?{pipeline:r,bestPosition:H(r[r.length-1][0])}:{errors:o})),a==i.length||a>r.length||(0===a?(({sourceImage:e,crop:t,layerConfig:i,layersConfig:n,incrementIndex:r,pipeline:o,layerCompleteCallback:a=null,i:s})=>{const{useEveryXPixel:l,useEveryXLayer:c,threshold:d}=i,[h,g,u]=$(e,t,{useEveryXPixel:l,useEveryXLayer:c,threshold:d});o.push([h,g,u]),null!=a&&a({layers:n.length,layerFinished:s+1}),r()})({sourceImage:e,crop:t,layerConfig:i[a],layersConfig:i,layerCompleteCallback:n,incrementIndex:s,pipeline:r,i:a}):(o=(({pipeline:e,i:t})=>{let i=null;return null!=e[t-1][0]&&0!==e[t-1][0].length&&e[t-1][0].some((e=>null!=e))||(i=["No match found"]),i})({pipeline:r,i:a}),o?l({errors:o}):(({sourceImage:e,crop:t,layerConfig:i,layersConfig:n,incrementIndex:r,pipeline:o,layerCompleteCallback:a=null,i:s})=>{const{useEveryXPixel:l,useEveryXLayer:c,threshold:d}=i,h=[H(o[s-1][0])],[g,u,p]=A(e,t,h,o[s-1][1],{useEveryXPixel:l,useEveryXLayer:c,threshold:d});o.push([g,u,p]),null!=a&&a({layers:n.length,layerFinished:s+1}),r()})({sourceImage:e,crop:t,layerConfig:i[a],layersConfig:i,layerCompleteCallback:n,incrementIndex:s,pipeline:r,i:a})))}),0)}))},U=async(e,t,{isRotated:i=!1,pipelineLayerCompleteCallback:n=null}={})=>{const r=((e,t)=>{const i=I(e);return[{useEveryXPixel:i,useEveryXLayer:50,threshold:.1},{useEveryXPixel:i,useEveryXLayer:5,threshold:.12},{useEveryXPixel:1,useEveryXLayer:1,threshold:t?.03:.01}]})(t,i),{errors:o,pipeline:a,bestPosition:s}=await N(e,t,r,n);return{errors:o,pipeline:a,bestPosition:s}};function B(e,t,i){return e+i*t}const T=(e,t,i)=>{const n=e[B(0,0,t)],r=e[B(t,0,t)],o=e[B(0,i-1,t)],a=e[B(t-1,i-1,t)];return 0==n&&0==r&&0==o&&0==a},G=(e,t,i)=>{let n=t;for(let o=t-1;o>=0&&0===e[B(o-1,0,t)];o--)n=o;let r=0;for(let o=1;o<=i&&0===e[B(t-1,o,t)];o++)r=o;return{leftMostBlackPixel:n,bottomMostBlackPixel:r}},O=(e,t,i,n)=>{const r=t-i,o=.5*r*n;let a=0;for(let s=i;s<t;s++)for(let i=0;i<n;i++)0===e[B(s,i,t)]&&a++;return{cornerIsATriangle:a/o>=.45,width:r}},j=()=>{const{isRotated:e,angle:t}=(e=>{const{data:t,imageWidth:i,imageLength:n}=e.data[0];let r=!0,o=null;T(t,i,n)||(r=!1);const{leftMostBlackPixel:a,bottomMostBlackPixel:s}=G(t,i,n);a===i&&0===s&&(r=!1);const{cornerIsATriangle:l,width:c}=O(t,i,a,s);return l||(r=!1),r&&(o=180*Math.atan(s/c)/Math.PI),{isRotated:r,angle:o}})(u.crop);return e?Y(t):F(),{isRotated:e,angle:t}},Y=e=>{const t=u.crop.data[0],i=((e,t,i,n,r=1)=>{let o=w(e,t,i,n);return o=v(o,n),f(o,r)})(t.data,t.imageWidth,t.imageLength,e,u.crop.data.length);u.crop={data:i,original:u.crop.original,dimensions:u.crop.dimensions,originalDimensions:u.crop.originalDimensions,angle:e,isRotated:!0}},F=()=>{const t=((t,i,n,r,{width:o=150,height:a=150}={})=>{let s=new e(i,n,t,{kind:"GREY"});const l=Math.min(o,i),c=Math.min(a,n);return s=s.crop({x:0,y:0,width:l,height:c}),f(s,r)})(u.crop.data[0].data,u.crop.dimensions.width,u.crop.dimensions.height,u.crop.data.length,{width:150,height:150});u.crop={data:t,original:u.crop.original,dimensions:u.crop.dimensions,originalDimensions:u.crop.originalDimensions}},K=(e,t,i=0)=>{const n=t.width,r=t.height,o=e.dimensions.width,a=[];for(let s=0;s<r;s++)for(let t=0;t<n;t++){const n=e.data[s].data[t+i*o];a.push(n)}return new Uint8Array(a)},V=(e,t,i=0)=>{const n=t.width,r=t.height,o=e.dimensions.width,a=[];for(let s=0;s<r;s++)for(let t=0;t<n;t++){const n=e.data[s].data[i+t*o];a.push(n)}return new Uint8Array(a)},_=(e,t)=>"left"==t?{width:e.dimensions.height,height:e.data.length,length:e.dimensions.width}:"top"==t?{width:e.dimensions.width,height:e.data.length,length:e.dimensions.height}:void 0,J=(t,i,n)=>new e(i,n,t,{kind:"GREY"}).rotateRight().flipX(),Q=async e=>{u.crop.data=u.crop.original,u.crop.dimensions=u.crop.originalDimensions,Z(e);const t=j();return{imageRotatedInfo:t,results:await U(u.sourceImage,u.crop,{isRotated:t.isRotated,isResliced:!0,pipelineLayerCompleteCallback:m}),reslicedDirection:e}},Z=(e,t=0)=>{u.crop=((e,t="left",i=0)=>{const n=_(e,t),r="top"==t?K(e,n,i):V(e,n,i);return{data:f(J(r,n.width,n.height),n.length),original:e.data,dimensions:n,originalDimensions:e.dimensions}})(u.crop,e,t)},ee=async()=>{let e=!1;const{errors:t,bestPosition:i,isRotated:n,reslicedDirection:r}=await(async()=>{let e=null,t=j(),i=await U(u.sourceImage,u.crop,{isRotated:t.isRotated,pipelineLayerCompleteCallback:m});if(null!=i.errors&&i.errors.length>0){const n=await Q("top");t=n.imageRotatedInfo,i=n.results,e=n.reslicedDirection}if(null!=i.errors&&i.errors.length>0){const n=await Q("left");t=n.imageRotatedInfo,i=n.results,e=n.reslicedDirection}return{errors:i.errors,bestPosition:i.bestPosition,isRotated:t.isRotated,reslicedDirection:e}})();if(y(t),te(t))(()=>{const e=u.sourceImage.data[0];b({imageData:e.data,width:e.imageWidth,height:e.imageLength,canvasElement:S})})();else{e=!0;const t=ie(i);if(ne(t),u.crop.position=t,u.crop.reslicedDirection=r,null==u.mainCrop&&(u.mainCrop=u.crop),((e,t)=>{if(e.layer!=t.layer)return!1;const i=t.x<e.x&&t.y<e.y,n=t.x+t.width>e.x+e.width,r=t.y+t.height>e.y+e.height;return i&&n&&r})({x:u.crop.position.x,y:u.crop.position.y,layer:u.crop.position.z,width:u.crop.dimensions.width,height:u.crop.dimensions.height},{x:u.mainCrop.position.x,y:u.mainCrop.position.y,layer:u.mainCrop.position.z,width:u.mainCrop.dimensions.width,height:u.mainCrop.dimensions.height})){const e={position:t,isNested:!0};n?C(e):X(e)}else u.mainCrop=u.crop,(()=>{const e=u.sourceImage.data[u.crop.position.z-1];b({imageData:e.data,width:e.imageWidth,height:e.imageLength,canvasElement:S})})(),n?C({position:t}):X({position:t})}return e},te=e=>null!=e&&e.length>0,ie=e=>Object.assign({},e),ne=e=>e.z++,re=async({imagePath:e=null,arrayBuffer:t=null})=>{if(null==e&&null==t)return{errors:["No image provided"]};if(null!=e){const i=(e=>{const t=[];return null!=e&&null!=e||t.push("No image path provided"),t})(e);if(0!=i.length)return{errors:i};t=await(async e=>{const t=await r.get(e,{responseType:"arraybuffer"});return o.Buffer.from(t.data,"utf-8")})(e)}let i;try{i=n(t)}catch(a){return{errors:["An image provided is not a tiff. Currently this tool only accepts tiffs."]}}return{data:i}},oe=({errorHandler:e=y,callback:t})=>async i=>{const n=i.target.files[0],r=await n.arrayBuffer(),{data:o,errors:a}=await re({arrayBuffer:r});e(a),null!=o&&t({data:o,original:o,dimensions:{width:o[0].imageWidth,height:o[0].imageLength},originalDimensions:{width:o[0].imageWidth,height:o[0].imageLength}})},ae=e=>e[0].toUpperCase()+e.slice(1),se=()=>{const e=oe({callback:le("sourceImage")}),i=oe({callback:le("crop")});return{replaceCropUploadHandler:oe({callback:e=>{if(null==u.crop||null==u.crop.position)return;if(u.crop.dimensions.width!=e.dimensions.width||u.crop.dimensions.height!=e.dimensions.height)return void(document.querySelector("#warning-text").style.display="block");document.querySelector("#warning-text").style.display="none";const i=document.querySelector("#replaced-crop-canvas"),n=u.sourceImage.data[u.crop.position.z-1];(async({imageData:e,width:i,height:n,canvasElement:r,imageRange:o=[0,255],colorScale:a="greys",cropPosition:s,cropDimensions:l,angle:c=null,newCrop:d})=>{const h=r.getContext("2d"),{x:g,y:u}=s,{width:p,height:m}=l,y=new t({canvas:r,data:e,width:i,height:n,domain:o,colorScale:a,useWebGL:!1});y.render();const f=document.createElement("canvas");new t({canvas:f,data:d.data[0].data,width:d.dimensions.width,height:d.dimensions.height,domain:o,colorScale:a,useWebGL:!1}).render();const w=f.getContext("2d"),v=await createImageBitmap(w.getImageData(0,0,d.dimensions.width,d.dimensions.height));if(h.save(),h.translate(g+p/2,u+m/2),null!=c&&h.rotate(x(c)),h.drawImage(v,-p/2,-m/2),h.restore(),null!=c){h.save();const e=await createImageBitmap(h.getImageData(g,u,p,m));h.translate(g+p/2,u+m/2),h.drawImage(e,-p/2,-m/2),h.restore()}document.querySelector("#replaced-crop-canvas").style.visibility="visible"})({imageData:n.data,width:n.imageWidth,height:n.imageLength,canvasElement:i,cropPosition:u.crop.position,cropDimensions:u.crop.dimensions,angle:u.crop.isRotated?u.crop.angle:null,newCrop:e})}}),sourceImageUploadHandler:e,cropImageUploadHandler:i}},le=e=>async t=>{if(u[e]=t,null==u.sourceImage||null==u.crop||!(()=>{const e=((e,t)=>{const i=[];return null!=e&&null!=e||i.push("The source image provided is not defined"),null!=t&&null!=t||i.push("The cropped image provided is not defined"),(e.data.length<t.data.length||e.dimensions.width<t.dimensions.width||e.dimensions.height<t.dimensions.height)&&i.push("The source image provided is smaller than the cropped image"),e.data.length==t.data.length&&e.dimensions.width==t.dimensions.width&&e.dimensions.height==t.dimensions.height&&i.push("The crop provided is the same size as the source image"),i})(u.sourceImage,u.crop);return y(e),0==e.length})())return;document.querySelector("#replaced-crop-canvas").style.visibility="hidden",document.querySelector("#info-area").style.visibility="visible",document.querySelector("#warning-text").style.display="none",p(0);await ee()&&((()=>{const e=`${u.crop.position.x}-${u.crop.position.x+u.crop.dimensions.width}`,t=`${u.crop.position.y}-${u.crop.position.y+u.crop.dimensions.height}`,i=`${u.crop.position.z}-${u.crop.position.z+u.crop.data.length}`,n=null!=u.crop.isRotated?`${Math.round(u.crop.angle)}`:"",r=null!=u.crop.reslicedDirection?`Resliced from: ${ae(u.crop.reslicedDirection)}`:"",o=`Crop Position: <br> x - ${e}, y - ${t}, z - ${i} ${null!=u.crop.isRotated?`<br> Rotated - ${n}Â°`:""} ${null!=u.crop.reslicedDirection?`<br> ${r}`:""}`;document.querySelector("#crop-info").innerHTML=o})(),P())};!function(e={}){const{immediate:t=!1,onNeedRefresh:i,onOfflineReady:n}=e;let r;"serviceWorker"in navigator&&(r=new a("./sw.js",{scope:"./"}),r.addEventListener("activated",(e=>{e.isUpdate?window.location.reload():null==n||n()})),r.register({immediate:t}).then((e=>e)))}({onOfflineReady(){console.log("Working in offline mode.")}}),(()=>{const{replaceCropUploadHandler:e,sourceImageUploadHandler:t,cropImageUploadHandler:i}=se();window.addEventListener("load",(function(){document.querySelector("#new-crop-input").addEventListener("change",e),document.querySelector("#source-image-input").addEventListener("change",t),document.querySelector("#crop-image-input").addEventListener("change",i),document.querySelector("#toggle-guide-text").addEventListener("click",l)}))})();
