import{g as e,d as t,a as r,b as n,p as a,I as i}from"./vendor.a78a7e74.js";const s=new e.exports.GPU({mode:"gpu"});function o(e,t,r){return e+r*t}s.addFunction(o);const h=(e,t,r)=>{const n=Math.trunc(Math.abs(e.data[0].imageWidth-t.data[0].imageWidth)/r),a=Math.trunc(Math.abs(e.data[0].imageLength-t.data[0].imageLength)/r);return s.createKernel((function(e,t){const r=this.thread.x*this.constants.useEveryXPixel,n=this.thread.y*this.constants.useEveryXPixel;let a=0;for(let i=0;i<this.constants.cropLayerWidth;i+=this.constants.useEveryXPixel){const s=r+i;for(let i=0;i<this.constants.cropLayerLength;i+=this.constants.useEveryXPixel){const h=n+i,c=o(s,h,this.constants.sourceImageLayerWidth),d=o(s-r,h-n,this.constants.cropLayerWidth),l=e[c],u=t[d];a+=Math.abs(l-u)}}return a})).setOutput([n,a]).setConstants({sourceImageLayerWidth:e.data[0].imageWidth,cropLayerWidth:t.data[0].imageWidth,cropLayerLength:t.data[0].imageLength,useEveryXPixel:r})},c=(e,t,r,n,a,i,h)=>{const{xAxisScans:c,yAxisScans:d}=l(e,t,r,n);return s.createKernel((function(e,t){const r=this.thread.x*this.constants.useEveryXPixel+this.constants.originX,n=this.thread.y*this.constants.useEveryXPixel+this.constants.originY;let a=0;for(let i=0;i<this.constants.cropLayerWidth;i+=this.constants.useEveryXPixel){const s=r+i;for(let i=0;i<this.constants.cropLayerLength;i+=this.constants.useEveryXPixel){const h=n+i,c=o(s,h,this.constants.sourceImageLayerWidth),d=o(s-r,h-n,this.constants.cropLayerWidth),l=e[c],u=t[d];a+=Math.abs(l-u)}}return a})).setOutput([c,d]).setConstants({sourceImageLayerWidth:e.data[0].imageWidth,cropLayerWidth:t.data[0].imageWidth,cropLayerLength:t.data[0].imageLength,useEveryXPixel:a,originX:i,originY:h})},d=(e,t,r)=>Math.min(Math.max(e,t),r),l=(e,t,r,n)=>{const{useEveryXPixel:a,useEveryXLayer:i}=n(),s=Math.abs(e.data[0].imageWidth-t.data[0].imageWidth),o=d(r.x-a,0,s),h=d(r.x+a,0,s)-o,c=Math.abs(e.data[0].imageLength-t.data[0].imageLength),l=d(r.y-a,0,c),u=d(r.y+a,0,c)-l,g=Math.abs(e.data.length-t.data.length),y=d(r.z-i,0,g);return{xScanStart:o,xAxisScans:h,yScanStart:l,yAxisScans:u,zScanStart:y,zAxisScans:d(r.z+i,0,g)-y}},u=({result:e,crop:t,convertPosition:r,threshold:n=.1})=>{const{useEveryXPixel:a,useEveryXLayer:i}=r(),s=(({threshold:e=.1,cropWidth:t,cropHeight:r,range:n=[0,255],useEveryXPixel:a})=>e*Math.abs(n[0]-n[1])*Math.trunc(t/a*r/a))({threshold:n,cropWidth:t.data[0].imageWidth,cropHeight:t.data[0].imageLength,useEveryXPixel:a,useEveryXLayer:i}),o=[];for(const[h,c]of Object.entries(e))for(const[e,t]of Object.entries(c))for(const[r,n]of Object.entries(t))if(n<s){const t=[h,e,r].map((e=>parseInt(e)));o.push({difference:n,index:t})}if(0==o.length)return null;return o.map((e=>{const t=e.index;return Object.assign(r({x:t[2],y:t[1],z:t[0]}),{difference:e.difference})}))},g=(e,t,{useEveryXPixel:r,useEveryXLayer:n,threshold:a})=>{const[i,s]=((e,t,{useEveryXLayer:r,useEveryXPixel:n})=>{const a=h(e,t,n),i=Math.abs(e.data.length-t.data.length);let s=[];for(let o=0;o<=i;o+=r){const r=e.data[o],n=t.data[0];s.push(a(r.data,n.data))}return a.destroy(),[s,(e=null)=>null==e?{useEveryXPixel:n,useEveryXLayer:r}:{x:e.x*n,y:e.y*n,z:e.z*r}]})(e,t,{useEveryXPixel:r,useEveryXLayer:n});return[u({result:i,crop:t,convertPosition:s,threshold:a}),s,i]},y=(e,t,r,n,{useEveryXPixel:a,useEveryXLayer:i,threshold:s})=>{const[o,h]=((e,t,r,n,{useEveryXLayer:a,useEveryXPixel:i})=>{const s=r.map(((a,s)=>{const{xScanStart:o,yScanStart:h}=l(e,t,r[s],n);return c(e,t,a,n,i,o,h)})).map(((i,s)=>{const{zScanStart:o,zAxisScans:h}=l(e,t,r[s],n);let c=[];for(let r=o;r<=o+h;r+=a){const n=e.data[r],a=t.data[0];c.push(i(n.data,a.data))}return i.destroy(),c})),{zScanStart:o,xScanStart:h,yScanStart:d}=l(e,t,r[0],n);return[s,(e=null)=>null==e?{useEveryXPixel:i,useEveryXLayer:a}:{x:e.x*i+h,y:e.y*i+d,z:e.z*a+o}]})(e,t,r,n,{useEveryXPixel:a,useEveryXLayer:i});return[o.map((e=>u({result:e,crop:t,convertPosition:h,threshold:s}))).reduce(((e,t)=>e.concat(t)),[]),h,o]},p=e=>e.reduce(((e,t)=>null==t?e:t.difference<e.difference?t:e),{difference:Number.MAX_VALUE}),m=async(e,t,{isRotated:r=!1,pipelineLayerCompleteCallback:n=null}={})=>{const{errors:a,pipeline:i,bestPosition:s}=await((e,t,r,n=null)=>{const a=[];let i=0;return new Promise((s=>{const o=setInterval((()=>{if(i==r.length)return clearInterval(o),void s({pipeline:a,bestPosition:p(a[a.length-1][0])});if(i>a.length)return;const{useEveryXPixel:h,useEveryXLayer:c,threshold:d}=r[i];if(0===i){const[s,o,l]=g(e,t,{useEveryXPixel:h,useEveryXLayer:c,threshold:d});return a.push([s,o,l]),null!=n&&n({layers:r.length,layerFinished:i+1}),void i++}if(null==a[i-1][0]||0===a[i-1][0].length)return clearInterval(o),void s({errors:["No match found"]});if(!a[i-1][0].some((e=>null!=e)))return clearInterval(o),void s({errors:["No match found"]});const l=[p(a[i-1][0])],[u,m,v]=y(e,t,l,a[i-1][1],{useEveryXPixel:h,useEveryXLayer:c,threshold:d});a.push([u,m,v]),null!=n&&n({layers:r.length,layerFinished:i+1}),i++}),0)}))})(e,t,r?[{useEveryXPixel:5,useEveryXLayer:50,threshold:.1},{useEveryXPixel:1,useEveryXLayer:1,threshold:.03}]:[{useEveryXPixel:10,useEveryXLayer:50,threshold:.1},{useEveryXPixel:10,useEveryXLayer:5,threshold:.06},{useEveryXPixel:1,useEveryXLayer:1,threshold:.01}],n);return{errors:a,pipeline:i,bestPosition:s}},v=e=>{document.querySelector("#progress-bar > div").style.width=`${Math.round(100*e)}%`},f=e=>{null!=e&&null!=e&&e.forEach((e=>(e=>{document.querySelector("#crop-info").innerHTML=`<span>${e}</span>`,v(1)})(e)))},x=async({imagePath:e=null,arrayBuffer:a=null})=>{if(null==e&&null==a)return{errors:["No image provided"]};if(null!=e){const t=(e=>{const t=[];return null!=e&&null!=e||t.push("No image path provided"),t})(e);if(0!=t.length)return{errors:t};a=await(async e=>{const t=await r.get(e,{responseType:"arraybuffer"});return n.Buffer.from(t.data,"utf-8")})(e)}let i;try{i=t(a)}catch(s){return{errors:["An image provided is not a tiff. Currently this tool only accepts tiffs."]}}return{data:i}},L=({errorHandler:e=f,callback:t})=>async r=>{const n=r.target.files[0],a=await n.arrayBuffer(),{data:i,errors:s}=await x({arrayBuffer:a,getImageDimensions:async()=>{const e=window.URL.createObjectURL(n);return await(e=>new Promise((t=>{const r=new Image;r.onload=()=>{t({imageHeight:r.height,imageWidth:r.width})},r.src=e})))(e)}});e(s),null!=i&&t({data:i,dimensions:{width:i[0].imageWidth,height:i[0].imageLength}})},E=(e,t,r,{strokeColor:n="rgb(64, 196, 82)",highlightColor:a="rgba(64, 196, 82, 0.3)"}={})=>{const i=e.getContext("2d");i.fillStyle=a,i.strokeStyle=n;const{x:s,y:o}=t,{w:h,h:c}=r;i.fillRect(s,o,h,c),i.strokeRect(s,o,h,c)},X=({imageData:e,width:t,height:r,canvasElement:n,imageRange:i=[0,255],colorScale:s="greys"})=>{const o=new a({canvas:n,data:e,width:t,height:r,domain:i,colorScale:s,useWebGL:!1});return o.render(),o};function w(e,t,r){return e+r*t}const P=(e,t,r,n)=>{let a=new i(t,r,e,{kind:"GREY"});return a=a.rotate(-n,{interpolation:"bilinear"}),a},S=(e,t)=>{const r=e.parent.width,n=Math.abs(r*Math.sin(b(t))),a=n/(Math.abs(r*Math.cos(b(t)))+n)*r,i=Math.trunc(a*Math.cos(b(t))),s=Math.trunc(n-a*Math.sin(b(t))),o=e.width-s-i,h=e.height-i-s;return e=e.crop({x:i,y:s,width:o,height:h})},b=e=>e*Math.PI/180,M=(e,t)=>(e.imageWidth=e.width,e.imageLength=e.height,Array.from({length:t},(t=>e)));let W=!0;const z=()=>{document.querySelector("#guide-text-container").style.display="block"},I=()=>{document.querySelector("#guide-text-container").style.display="none"},R=()=>{document.querySelector("#toggle-guide-text").innerHTML="Show Usage Guide"},C=()=>{document.querySelector("#toggle-guide-text").innerHTML="Hide Usage Guide"},$={sourceImage:null,crop:null},k=L({callback:e=>{$.sourceImage=e,j()}}),q=L({callback:e=>{$.crop=e,j()}});document.querySelector("#source-image-input").addEventListener("change",k),document.querySelector("#crop-image-input").addEventListener("change",q),document.querySelector("#toggle-guide-text").addEventListener("click",(()=>{if(W)return z(),C(),void(W=!1);I(),R(),W=!0}));const A=e=>{const t=$.crop.data[0],r=((e,t,r,n,a=1)=>{let i=P(e,t,r,n);return i=S(i,n),M(i,a)})(t.data,t.imageWidth,t.imageLength,e,$.crop.data.length);$.crop={data:r,dimensions:$.crop.dimensions,angle:e,isRotated:!0}},H=()=>{const e=((e,t,r,n,{width:a=150,height:s=150}={})=>{let o=new i(t,r,e,{kind:"GREY"});const h=Math.min(a,t),c=Math.min(s,r);return o=o.crop({x:0,y:0,width:h,height:c}),M(o,n)})($.crop.data[0].data,$.crop.dimensions.width,$.crop.dimensions.height,$.crop.data.length,{width:150,height:150});$.crop={data:e,dimensions:$.crop.dimensions}},T=({position:e,sourceCanvas:t})=>{const r={width:$.crop.data[0].imageWidth,height:$.crop.data[0].imageLength},{position:n,width:a,height:i}=((e,t,r)=>({position:{x:e.x-Math.round((r.width-t.width)/2),y:e.y-Math.round((r.height-t.height)/2),z:e.z},width:r.width,height:r.height}))(e,r,$.crop.dimensions);$.crop.position=n,E(t,n,{w:a,h:i})},O=({layers:e,layerFinished:t})=>{v(t/e)},j=async()=>{if(null==$.sourceImage||null==$.crop)return;document.querySelector("#info-area").style.visibility="visible",v(0);const e=document.querySelector("#source-image-canvas"),t=$.sourceImage.data[0];X({imageData:t.data,width:t.imageWidth,height:t.imageLength,canvasElement:e});const r=((e,t)=>{const r=[];return null!=e&&null!=e||r.push("The source image provided is not defined"),null!=t&&null!=t||r.push("The cropped image provided is not defined"),(e.data.length<t.data.length||e.dimensions.width<t.dimensions.width||e.dimensions.height<t.dimensions.height)&&r.push("The source image provided is smaller than the cropped image"),e.data.length==t.data.length&&e.dimensions.width==t.dimensions.width&&e.dimensions.height==t.dimensions.height&&r.push("The crop provided is the same size as the source image"),r})($.sourceImage,$.crop);if(f(r),r.length>0)return;const{isRotated:n,angle:a}=(e=>{const{data:t,imageWidth:r,imageLength:n}=e.data[0],a=t[w(0,0,r)],i=t[w(r,0,r)],s=t[w(0,n-1,r)],o=t[w(r-1,n-1,r)];if(0!==a||0!==i||0!==s||0!==o)return{isRotated:!1};let h=r;for(let g=r-1;g>=0&&0===t[w(g-1,0,r)];g--)h=g;let c=0;for(let g=1;g<=n&&0===t[w(r-1,g,r)];g++)c=g;if(h===r&&0===c)return{isRotated:!1};const d=r-h,l=.5*d*c;let u=0;for(let g=h;g<r;g++)for(let e=0;e<c;e++)0===t[w(g,e,r)]&&u++;return u/l<.45?{isRotated:!1}:{isRotated:!0,angle:180*Math.atan(c/d)/Math.PI}})($.crop);n?A(a):H();const{errors:i,bestPosition:s}=await m($.sourceImage,$.crop,{isRotated:n,pipelineLayerCompleteCallback:O});if(f(i),null!=i&&i.length>0)return;const o={x:s.x,y:s.y,z:s.z+1};$.crop.position=o;const h=$.sourceImage.data[o.z-1];X({imageData:h.data,width:h.imageWidth,height:h.imageLength,canvasElement:e}),n?T({position:o,sourceCanvas:e}):(({position:e,sourceCanvas:t})=>{const{position:r,width:n,height:a}=((e,t)=>({position:{x:e.x,y:e.y,z:e.z},width:t.width,height:t.height}))(e,$.crop.dimensions);$.crop.position=r,E(t,r,{w:n,h:a})})({position:o,sourceCanvas:e}),G()},G=()=>{const e=`${$.crop.position.x}-${$.crop.position.x+$.crop.dimensions.width}`,t=`${$.crop.position.y}-${$.crop.position.y+$.crop.dimensions.height}`,r=`${$.crop.position.z}-${$.crop.position.z+$.crop.data.length}`,n=null!=$.crop.isRotated?`${Math.round($.crop.angle)}`:"",a=`Crop Position: <br> x - ${e}, y - ${t}, z - ${r} ${null!=$.crop.isRotated?`<br> Rotated - ${n}°`:""}`;document.querySelector("#crop-info").innerHTML=a};
